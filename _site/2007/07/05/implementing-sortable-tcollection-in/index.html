<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Implementing a sortable TCollection in Delphi | Chris Miller’s 4th Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Implementing a sortable TCollection in Delphi" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Delphi’s TCollection class is very useful, but out of the box it lacks the ability to sort the items in the list.  Fortunately, this is easily addressable accessing some private properties of the TCollection class.  Internally, the items in a TCollection are stored in a private TList named FList. " />
<meta property="og:description" content="Delphi’s TCollection class is very useful, but out of the box it lacks the ability to sort the items in the list.  Fortunately, this is easily addressable accessing some private properties of the TCollection class.  Internally, the items in a TCollection are stored in a private TList named FList. " />
<link rel="canonical" href="http://localhost:4000/2007/07/05/implementing-sortable-tcollection-in/" />
<meta property="og:url" content="http://localhost:4000/2007/07/05/implementing-sortable-tcollection-in/" />
<meta property="og:site_name" content="Chris Miller’s 4th Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2007-07-05T18:24:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Implementing a sortable TCollection in Delphi" />
<script type="application/ld+json">
{"datePublished":"2007-07-05T18:24:00-04:00","@type":"BlogPosting","url":"http://localhost:4000/2007/07/05/implementing-sortable-tcollection-in/","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2007/07/05/implementing-sortable-tcollection-in/"},"dateModified":"2007-07-05T18:24:00-04:00","description":"Delphi’s TCollection class is very useful, but out of the box it lacks the ability to sort the items in the list.  Fortunately, this is easily addressable accessing some private properties of the TCollection class.  Internally, the items in a TCollection are stored in a private TList named FList. ","headline":"Implementing a sortable TCollection in Delphi","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Chris Miller's 4th Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chris Miller&#39;s 4th Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Implementing a sortable TCollection in Delphi</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2007-07-05T18:24:00-04:00" itemprop="datePublished">Jul 5, 2007
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href="http://www.codegear.com/products/delphi/win32">Delphi’s</a> <a href="http://www.freepascal.org/docs-html/rtl/classes/tcollection.html">TCollection</a> class is very useful, but out of the box it lacks the ability to sort the items in the list.  Fortunately, this is easily addressable accessing some private properties of the TCollection class.  Internally, the items in a TCollection are stored in a private TList named FList. </p>

<p>The trick is to get access to a private property.  The way to do this is by creating a shadow class.  A shadow class is a class that matches the private declaration of the class that you need to access.  The shadow needs to have the same field types in the same order, up to and including the field that you need access to.  This is the risky part, and cover that risk later.  The definition of the TCollection class starts out with:&lt;/p&gt;</p>

<div contenteditable="false">
  <pre><div>
  <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
  
  <span>  TCollection </span><span>=</span><span> </span><span>class</span><span>(TPersistent)<br /></span><span>private</span><span><br />    FItemClass: TCollectionItemClass;<br />    FItems: TList;<br />    FUpdateCount: Integer;<br />    FNextID: Integer;<br />    FPropName: string;<br /></span>
</div></pre>
  
  <p>
    <!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com -->&lt;/div&gt; 
    
    <p>
    </p>
    
    <p>
    </p>
    
    <p>
      To get at FItems, we need to shadow the top two members of the class.  Which provides this shadow class:
    </p>
    
    <p>
    </p>
    
    <p>
    </p>
    
    <div contenteditable="false">
      <pre><div>
  <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
  
  <span>  TShadowedCollection </span><span>=</span><span> </span><span>class</span><span>(TPersistent)<br /></span><span>private</span><span><br />    FItemClass: TCollectionItemClass;<br />    FItems: TList;<br /></span><span>end</span><span>;<br /></span>
</div></pre>
      
      <p>
        <!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com -->&lt;/div&gt; 
        
        <p>
        </p>
        
        <p>
        </p>
        
        <p>
          With access to the internal list, it becomes a simple task to provide the ability to the sort the list.  A public Sort method will call an internal method that runs a <a href="http://en.wikipedia.org/wiki/Quicksort">Quicksort</a> across the list.  The Quicksort code will process the list obtained by casting itself as TShadowedCollection, allowing access to FItems and then call a Compare() function to compare items in the FItems list.  The collection will provide a &#8220;do nothing&#8221; Compare() function.  It will be up to the descendant class to override that function and implement the actual comparision code.  The full source code for the class would look something like this:
        </p>
        
        <p>
        </p>
        
        <div contenteditable="false">
          <pre><div>
  <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
  
  <span>unit</span><span> SortCollections;<br /><br /></span><span>interface</span><span><br /><br /></span><span>uses</span><span> classes;<br /><br /></span><span>type</span><span><br />  TSortableCollection </span><span>=</span><span> </span><span>class</span><span>(TCollection)<br /></span><span>protected</span><span><br /></span><span>function</span><span> Compare(Item1, Item2 : TCollectionItem) : integer; virtual;<br /></span><span>procedure</span><span> QuickSort(L, R: Integer);<br /></span><span>public</span><span><br /></span><span>procedure</span><span> Sort;<br /></span><span>end</span><span>;<br /><br /></span><span>implementation</span><span><br /><br /></span><span>type</span><span><br /></span><span>//</span><span> Helper class to allow sorting of a TCollection</span><span><br /></span><span>  </span><span>{</span><span>$HINTS OFF</span><span>}</span><span><br />  TShadowedCollection </span><span>=</span><span> </span><span>class</span><span>(TPersistent)<br /></span><span>private</span><span><br />    FItemClass: TCollectionItemClass;<br />    FItems: TList;<br /></span><span>end</span><span>;<br /></span><span>{</span><span>$HINTS ON</span><span>}</span><span><br /><br /><br /></span><span>{</span><span> TSortableCollection </span><span>}</span><span><br /><br /></span><span>function</span><span> TSortableCollection.Compare(Item1, Item2: TCollectionItem): integer;<br /></span><span>begin</span><span><br /></span><span>(*</span><span><br /><br />Descendant classes would override this method and cast Item1 and Item2 to the<br />decendant class's collection item type perform the field comparisions<br /><br />if item1.MyField &lt; item2.MyField<br />  return -1<br />else if item1.MyField &gt; item2.MyField<br />  return 1<br />else return 0<br /><br /></span><span>*)</span><span><br />  result :</span><span>=</span><span> </span><span></span><span>;<br /></span><span>end</span><span>;<br /><br /></span><span>procedure</span><span> TSortableCollection.QuickSort(L, R: Integer);<br /></span><span>var</span><span><br />  I, J, p: Integer;<br />  Save: TCollectionItem;<br />  SortList: TList;<br /></span><span>begin</span><span><br /></span><span>//</span><span>This cast allows us to get at the private elements in the base class</span><span><br /></span><span>  SortList :</span><span>=</span><span> TShadowedCollection(Self).FItems;<br /><br /></span><span>repeat</span><span><br />    I :</span><span>=</span><span> L;<br />    J :</span><span>=</span><span> R;<br />    P :</span><span>=</span><span> (L </span><span>+</span><span> R) shr </span><span>1</span><span>;<br /></span><span>repeat</span><span><br /></span><span>while</span><span> Compare(Items[I], Items[P]) </span><span>&lt;</span><span> </span><span></span><span> </span><span>do</span><span><br />        Inc(I);<br /></span><span>while</span><span> Compare(Items[J], Items[P]) </span><span>&gt;</span><span> </span><span></span><span> </span><span>do</span><span><br />        Dec(J);<br /></span><span>if</span><span> I </span><span>&lt;=</span><span> J </span><span>then</span><span> </span><span>begin</span><span><br />        Save              :</span><span>=</span><span> SortList.Items[I];<br />        SortList.Items[I] :</span><span>=</span><span> SortList.Items[J];<br />        SortList.Items[J] :</span><span>=</span><span> Save;<br /></span><span>if</span><span> P </span><span>=</span><span> I </span><span>then</span><span><br />          P :</span><span>=</span><span> J<br /></span><span>else</span><span> </span><span>if</span><span> P </span><span>=</span><span> J </span><span>then</span><span><br />          P :</span><span>=</span><span> I;<br />        Inc(I);<br />        Dec(J);<br /></span><span>end</span><span>;<br /></span><span>until</span><span> I </span><span>&gt;</span><span> J;<br /></span><span>if</span><span> L </span><span>&lt;</span><span> J </span><span>then</span><span><br />      QuickSort(L, J);<br />    L :</span><span>=</span><span> I;<br /></span><span>until</span><span> I </span><span>&gt;=</span><span> R;<br /></span><span>end</span><span>;<br /><br /></span><span>procedure</span><span> TSortableCollection.Sort;<br /></span><span>begin</span><span><br /></span><span>if</span><span> Count </span><span>&gt;</span><span> </span><span>1</span><span> </span><span>then</span><span><br />    QuickSort(</span><span></span><span>, pred(Count));<br /></span><span>end</span><span>;<br /><br /></span><span>end</span><span>.</span>
</div></pre>
          
          <p>
            <!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com -->&lt;/div&gt; 
            
            <p>
            </p>
            
            <div>
              Tech Tags: <a href="http://technorati.com/tag/Delphi" rel="tag">Delphi</a> <a href="http://technorati.com/tag/TCollection" rel="tag">TCollection</a> <a href="http://technorati.com/tag/Sort" rel="tag">Sort</a>
            </div>
</p></div></p></div></p></div>

  </div><a class="u-url" href="/2007/07/05/implementing-sortable-tcollection-in/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Chris Miller&#39;s 4th Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Chris Miller&#39;s 4th Blog</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">anotherlab</span></a></li><li><a href="https://www.twitter.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">anotherlab</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
