<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Stream reading in C# | Chris Miller’s 4th Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Stream reading in C#" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I was banging my head against the wall with an odd stream reading problem.  I was making a web service call as straight http, no SOAP, when I hit a snag reading the response back.  I was making the request with a HttpWebRequest object and getting the HttpWebResponse response back by calling the HttpWebResponse GetResponse() method.  From the response object, I was using GetResponseStream() to get at the content.  The data coming back was of variable size.  You would get a fixed size header block, plus a number of fixed sized data entries.  The header block had a field to say how many data blocks there would be." />
<meta property="og:description" content="I was banging my head against the wall with an odd stream reading problem.  I was making a web service call as straight http, no SOAP, when I hit a snag reading the response back.  I was making the request with a HttpWebRequest object and getting the HttpWebResponse response back by calling the HttpWebResponse GetResponse() method.  From the response object, I was using GetResponseStream() to get at the content.  The data coming back was of variable size.  You would get a fixed size header block, plus a number of fixed sized data entries.  The header block had a field to say how many data blocks there would be." />
<link rel="canonical" href="http://localhost:4000/2006/08/24/stream-reading-in-c/" />
<meta property="og:url" content="http://localhost:4000/2006/08/24/stream-reading-in-c/" />
<meta property="og:site_name" content="Chris Miller’s 4th Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2006-08-24T22:05:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Stream reading in C#" />
<script type="application/ld+json">
{"datePublished":"2006-08-24T22:05:00-04:00","@type":"BlogPosting","url":"http://localhost:4000/2006/08/24/stream-reading-in-c/","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2006/08/24/stream-reading-in-c/"},"dateModified":"2006-08-24T22:05:00-04:00","description":"I was banging my head against the wall with an odd stream reading problem.  I was making a web service call as straight http, no SOAP, when I hit a snag reading the response back.  I was making the request with a HttpWebRequest object and getting the HttpWebResponse response back by calling the HttpWebResponse GetResponse() method.  From the response object, I was using GetResponseStream() to get at the content.  The data coming back was of variable size.  You would get a fixed size header block, plus a number of fixed sized data entries.  The header block had a field to say how many data blocks there would be.","headline":"Stream reading in C#","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Chris Miller's 4th Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chris Miller&#39;s 4th Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Stream reading in C#</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2006-08-24T22:05:00-04:00" itemprop="datePublished">Aug 24, 2006
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I was banging my head against the wall with an odd stream reading problem.  I was making a web service call as straight http, no SOAP, when I hit a snag reading the response back.  I was making the request with a HttpWebRequest object and getting the HttpWebResponse response back by calling the HttpWebResponse GetResponse() method.  From the response object, I was using GetResponseStream() to get at the content.  The data coming back was of variable size.  You would get a fixed size header block, plus a number of fixed sized data entries.  The header block had a field to say how many data blocks there would be.</p>

<p>Naively, I thought I could just use a BinaryReader on the data stream and read x number of bytes in for the header block.  The I would parse that header to the get number of data blocks and then call Read() for that number of data blocks.  Let’s say that the header block was 64 bytes in size and the data blocks were 32 bytes.  I had logic like the following:&lt;/p&gt;</p>

<p>HttpWebRequest req = (HttpWebRequest)WebRequest.Create(uri);<br />
HttpWebResponse resp = (HttpWebResponse)req.GetResponse();</p>

<p>Stream stream = resp.GetResponseStream();<br />
BinaryReader br = new BinaryReader(stream);</p>

<p>byte[] buff = new byte[Marshal.SizeOf(typeof(MyHeader))];</p>

<p>c = br.Read(buff, 0, 64);</p>

<p>GCHandle handle = GCHandle.Alloc(buff, GCHandleType.Pinned);<br />
MyHeader header = (MyHeader)Marshal.PtrToStructure(handle.AddrOfPinnedObject(), typeof(MyHeader));<br />
handle.Free();</p>

<p>LogEntry MyLogEntry;</p>

<p>for (int i=0; i &lt; MyHeader.EntryCount; i++)<br />
{<br />
  buff = new byte[Marshal.SizeOf(typeof(LogEntry))];<br />
  c = br.Read(buff, 0, 32);<br />
  if (c == 32)<br />
  {<br />
    handle = GCHandle.Alloc(buff, GCHandleType.Pinned);<br />
    LogEntry = (LogEntry)Marshal.PtrToStructure(handle.AddrOfPinnedObject(), typeof(LogEntry));<br />
    handle.Free();<br />
  }</p>

<p>}</p>

<p>The problem was that c was sometimes less than 32.  My bytes were disappearing.  I did some quick sanity check code like this:</p>

<p>c = br.Read(buff, 0, 8192);<br />
TotalBytes = c;&lt;/p&gt;</p>

<p>while (c &gt; 0)<br />
{<br />
  w.Write(buff, 0, c);<br />
  c = br.Read(buff, 0, 8192);<br />
  TotalBytes += c;<br />
}</p>

<p>When I ran that, TotalBytes had the expected number.  What was I missing?  A little bit of googling found this <a href="http://www.yoda.arachsys.com/csharp/readbinary.html">bit of extremely helpful information</a> from a guy named Jon.  I was reading while data was still coming into the stream.  The Read method is going to return before all of the data has been written to the source stream,  I had to read the stream into a holding array, by reading it as chunks, until there were no more bytes.  Then I could read the data from the array.  This was so obvious, I can’t believe I missed it.  The ReadFully() method that Jon supplied worked quite well.</p>

<p>In case you were wondering about the GCHandle stuff, that was needed to marshall C style structures into C# structures.  Getting that bit of code to work right is another story….</p>

<p> </p>

<div>
  Tech Tags: <a href="http://technorati.com/tag/C#" rel="tag">C#</a> <a href="http://technorati.com/tag/Binary+Data" rel="tag">Binary Data</a> <a href="http://technorati.com/tag/Stream" rel="tag">Stream</a> <a href="http://technorati.com/tag/HttpWebResponse" rel="tag">HttpWebResponse</a> <a href="http://technorati.com/tag/GetResponseStream" rel="tag">GetResponseStream</a>
</div>

  </div><a class="u-url" href="/2006/08/24/stream-reading-in-c/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Chris Miller&#39;s 4th Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Chris Miller&#39;s 4th Blog</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">anotherlab</span></a></li><li><a href="https://www.twitter.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">anotherlab</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
