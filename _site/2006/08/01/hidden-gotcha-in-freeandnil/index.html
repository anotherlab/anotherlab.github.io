<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Hidden gotcha in FreeAndNil() | Chris Miller’s 4th Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Hidden gotcha in FreeAndNil()" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Time to go memory leak hunting in my service. I’m using AutomatedQA‘s AQTime 4, a really cool tool. I’ve used it’s profiling features in the past, but not the memory leak detection. Since Delphi frees up your allocated memory when you exit the app and/or service, it’s too easy to get sloppy and not free up singleton types of objects. Well, that makes it harder to find actual memory leaks as AQTime is going to flag everything that wasn’t explicitly freed up as a leak. And that will lower the s/n ratio to make the too to hard to use." />
<meta property="og:description" content="Time to go memory leak hunting in my service. I’m using AutomatedQA‘s AQTime 4, a really cool tool. I’ve used it’s profiling features in the past, but not the memory leak detection. Since Delphi frees up your allocated memory when you exit the app and/or service, it’s too easy to get sloppy and not free up singleton types of objects. Well, that makes it harder to find actual memory leaks as AQTime is going to flag everything that wasn’t explicitly freed up as a leak. And that will lower the s/n ratio to make the too to hard to use." />
<link rel="canonical" href="http://localhost:4000/2006/08/01/hidden-gotcha-in-freeandnil/" />
<meta property="og:url" content="http://localhost:4000/2006/08/01/hidden-gotcha-in-freeandnil/" />
<meta property="og:site_name" content="Chris Miller’s 4th Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2006-08-01T05:10:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hidden gotcha in FreeAndNil()" />
<script type="application/ld+json">
{"datePublished":"2006-08-01T05:10:00-04:00","@type":"BlogPosting","url":"http://localhost:4000/2006/08/01/hidden-gotcha-in-freeandnil/","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2006/08/01/hidden-gotcha-in-freeandnil/"},"dateModified":"2006-08-01T05:10:00-04:00","description":"Time to go memory leak hunting in my service. I’m using AutomatedQA‘s AQTime 4, a really cool tool. I’ve used it’s profiling features in the past, but not the memory leak detection. Since Delphi frees up your allocated memory when you exit the app and/or service, it’s too easy to get sloppy and not free up singleton types of objects. Well, that makes it harder to find actual memory leaks as AQTime is going to flag everything that wasn’t explicitly freed up as a leak. And that will lower the s/n ratio to make the too to hard to use.","headline":"Hidden gotcha in FreeAndNil()","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Chris Miller's 4th Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chris Miller&#39;s 4th Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Hidden gotcha in FreeAndNil()</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2006-08-01T05:10:00-04:00" itemprop="datePublished">Aug 1, 2006
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Time to go memory leak hunting in my service. I’m using <a href="http://www.automatedqa.com/">AutomatedQA</a>‘s <a href="http://www.automatedqa.com/products/aqtime/index.asp">AQTime 4</a>, a really cool tool. I’ve used it’s profiling features in the past, but not the memory leak detection. Since Delphi frees up your allocated memory when you exit the app and/or service, it’s too easy to get sloppy and not free up singleton types of objects. Well, that makes it harder to find actual memory leaks as AQTime is going to flag everything that wasn’t explicitly freed up as a leak. And that will lower the <a href="http://mm.iit.uni-miskolc.hu/Data/texts/hackers_jargon/signal-to-noiseratio.HTML">s/n</a> ratio to make the too to hard to use.</p>

<p>So I’m pounding through the code and making sure that everything gets created, gets freed. Great fun, I recommend it for the entire family. I’m starting the service (actually the app version of service, but that’s another posting), then exiting it after it initiatizes. That way I can clear out all of the obvious suspects and then turn my attention to the serious memory leaks.</p>

<p>So I’m in the middle of doing this, when one of the objects that I am now explicitly freeing is now blowing up when I free it. And not in a good way. This object, let’s call him Fredo (not really the name), owns a few accessory objects (call them Phil and Reuben). In Fredo’s destructor, Fredo is destroying Phil &amp; Reuben. In Phil’s destructor, Phil references another object belonging to Fredo and blows up because Fredo has gone fishing and doesn’t exist anymore.</p>

<p>It took a while to figure out what was going on. You see Fredo wasn’t actually fishing, Fredo was still around. Phil was accessing Fredo through a global variable (bad legacy code) because Fredo was a singleton. The variable that reference Fredo had been set to nil, even though Fredo was still in existence.</p>

<p>It took a while, but I figured where and how I had broken Fredo. The code that I had added to destroy Fredo looked like this:</p>

<pre>FreeAndNil(Fredo);</pre>

<p>The FreeAndNil() procedure was added back around Delphi 3 or so. You pass in an object reference, it free’s that object and sets the reference to nil. Horse and buggy thinking for the managed code set, but useful in non-managed versions of Delphi. The problem was that FreeAndNil doesn’t exactly work that way. Let’s take a quick peek at that code:</p>

<pre><br /><b>procedure</b> FreeAndNil(<b>var</b> Obj);<br /><b>var</b><br />  Temp: TObject;<br /><b>begin</b><br />  Temp := TObject(Obj);<br />  Pointer(Obj) := <b>nil</b>;<br />  Temp.Free;<br /><b>end</b>;<br /></pre>

<p>It’s setting the variable to nil before it free’s it. It’s not how it’s documented and it caused my code to fail. There’s nothing wrong with how FreeAndNil is coded, by setting the variable to nil first, other objects can check to see if it still exists and not try to access that object while it’s being destroyed. I just would preferred that the documentation more accurately described the actual functionality.</p>

<div>
  Tech Tags: <a href="http://technorati.com/tag/Delphi" rel="tag">Delphi</a> <a href="http://technorati.com/tag/AutomatedQA" rel="tag">AutomatedQA</a> <a href="http://technorati.com/tag/AQTime" rel="tag">AQTime</a> <a href="http://technorati.com/tag/FreeAndNil" rel="tag">FreeAndNil</a> <a href="http://technorati.com/tag/Fredo" rel="tag">Fredo</a>
</div>

  </div><a class="u-url" href="/2006/08/01/hidden-gotcha-in-freeandnil/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Chris Miller&#39;s 4th Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Chris Miller&#39;s 4th Blog</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">anotherlab</span></a></li><li><a href="https://www.twitter.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">anotherlab</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
