<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.5">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2026-02-18T03:27:20+00:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Chris Miller’s 5th Blog</title><subtitle>My personal blog, 5th version</subtitle><author><name>Chris Miller</name></author><entry><title type="html">Backing up my main WSL2 Linux session</title><link href="http://localhost:4000/2026/02/17/backing-up-wsl2/" rel="alternate" type="text/html" title="Backing up my main WSL2 Linux session" /><published>2026-02-17T00:00:00+00:00</published><updated>2026-02-17T00:00:00+00:00</updated><id>http://localhost:4000/2026/02/17/backing-up-wsl2</id><content type="html" xml:base="http://localhost:4000/2026/02/17/backing-up-wsl2/"><![CDATA[<h1 id="backing-up-my-main-linux-session">Backing up my main Linux session</h1>
<p>TL;DR: I wrote a PowerShell script named backup-wsl2.ps1 to backup a Linux distribution.
You can run like this:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="n">\backup-wsl2.ps1</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="s2">"C:\Backups"</span><span class="w">
</span></code></pre></div></div>
<p>You can grab it from <a href="https://gist.github.com/anotherlab/0bfae255f41f87a83e31ec077bf3f606">here</a>. It’s pretty long so I wont display it, but I will do a mini-teardown.</p>

<p>I have a UBuntu session on my main Windows box, running under WSL2. I use it whenever I need to try something vaguely *ix like. I run <a href="https://rajapet.com/2021/10/19/controlling-a-wsl-installation-of-redis-server-from-the-windows-command-line/">redis</a> on it. And I generate the pages for this blog via <a href="https://rajapet.com/2021/12/15/Migrated-to-jekyll/">Jekyll</a>.</p>

<p>But I don’t have a backup for the Ubuntu session. My blog is literally a GitHub repo, but the files needed to run Jekyll are not.</p>

<p>About a year ago, the primary drive on my Windows box abruptly failed. It was a Sumsung 980 Pro 2 TB. That model and size had an issue with the firmware that would brick the drive. Long story short, Samsung replaced the drive under warranty with a 990 Pro and I reinstalled Windows.</p>

<p>I have a <a href="https://www.qnap.com/en-us/product/ts-464">QNap TS-464 NAS</a> that I use for backing up stuff. All of my files were backed up to it. I like the 464, it does exactly what I need and emails me when it needs something. I named it “swan” because it was a short name that I would remember.</p>

<p>I don’t backup OS images. When push comes to shove, I repave with the latest and greatest, then copy the files back down from swan.</p>

<p>I had to reinstall WSl2 and create a new Ubuntu image and then pull my blog files back down off of GitHub. But I had to reinstall Jekyll and get that mess running again.</p>

<p>So now I want to back up my Linux session to swan.</p>

<h1 id="steps-to-back-up-a-wsl-linux-session">Steps to back up a WSL Linux session</h1>
<p>It’s pretty easy. Run the following command</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wsl <span class="nt">--export</span> NameOfImage NameOfTarFile
</code></pre></div></div>
<p>If you want to restore from a TAR file, it works like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wsl <span class="nt">--import</span> &lt;NewDistroName&gt; &lt;InstallLocation&gt; &lt;Path<span class="se">\t</span>o<span class="se">\B</span>ackup.tar&gt;
</code></pre></div></div>

<h2 id="script-all-the-things">Script all the things</h2>
<p>I just needed to create a <a href="https://learn.microsoft.com/en-us/powershell/scripting/overview">PowerShell</a> script to create the TAR file and copy it to swan.</p>

<p><img src="/assets/images/script-all-the-things.jpg" alt="Yak Shaving" title="Yak shaving (again)" /></p>

<h3 id="getting-the-distribution-name">Getting the Distribution Name</h3>
<p>I could have hardcoded the name of the image, but where’s the fun in that? There are few ways of querying for the name of the image. My friend <a href="https://www.anthropic.com/news/claude-sonnet-4-5">Claude</a> suggested the following code:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Get-DefaultWSLDistribution</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wsl</span><span class="w"> </span><span class="nx">echo</span><span class="w"> </span><span class="s1">'$WSL_DISTRO_NAME'</span><span class="p">)</span><span class="o">.</span><span class="nf">Trim</span><span class="p">()</span><span class="w">

    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="nv">$default</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">throw</span><span class="w"> </span><span class="s2">"No default WSL distribution found."</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$default</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>The way this works is that when you invoke the <code class="language-plaintext highlighter-rouge">wsl</code>.exe<code class="language-plaintext highlighter-rouge"> command, it sets </code>$WSL_DISTRO_NAME` to the default distribution. It works but there is a delay in wsl being invoked with nothing to do. Ignoring the advice from the AI overlords, I came up with this instead:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Get-DefaultWSLDistributionQuick</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wsl</span><span class="w"> </span><span class="nt">--list</span><span class="w"> </span><span class="nt">--all</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="bp">$null</span><span class="w">

    </span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$p</span><span class="o">.</span><span class="nf">Trim</span><span class="p">()</span><span class="w">
        </span><span class="nv">$len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$line</span><span class="o">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="s1">' (Default)'</span><span class="p">)</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$len</span><span class="w"> </span><span class="o">-ge</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="kr">return</span><span class="w"> </span><span class="nv">$line</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$len</span><span class="p">)</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">return</span><span class="w"> </span><span class="bp">$null</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>When you run <code class="language-plaintext highlighter-rouge">wsl --list --all</code>, you’ll get (or at least I got) something like this:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Windows Subsystem for Linux Distributions:
Ubuntu-24.04 (Default)
</code></pre></div></div>
<p>There be dragons here, but we’ll get to that in a minute.</p>

<p>Right now, I only have a single Linux instance defined. And WSL was good enough to tag it with “(Default)”. The <code class="language-plaintext highlighter-rouge">foreach</code> walks through each line and returns the first session tagged with “(Default)” and then returns the text to the left of “ (Default)”.</p>

<p>With that, we can use this line to get the name of the Linux distribition to back up.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$defaultDistro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-DefaultWSLDistributionQuick</span><span class="w">
</span></code></pre></div></div>
<p>The $defaultDistro variable will contain the content “Ubuntu-24.04”. Here be dragons. Take this variable assignment:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sampleDistro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Ubuntu-24.04"</span><span class="w">
</span></code></pre></div></div>
<p>You would think that $defaultDistro and $sampleDistro have the same values. They don’t. The variable $defaultDistro will contain UTF-16 characters and $sampleDistro will have UTF-8 characters. The wsl command will return UTF-16 and will error out unless you use UTF-8. You can see the difference by piping each one into <code class="language-plaintext highlighter-rouge">Format-Hex</code> like this</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sampleDistro</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Format-Hex</span><span class="w">

   </span><span class="n">Label:</span><span class="w"> </span><span class="nx">String</span><span class="w"> </span><span class="p">(</span><span class="n">System.String</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;</span><span class="mi">3</span><span class="n">B9579CC</span><span class="err">&gt;</span><span class="w">

          </span><span class="n">Offset</span><span class="w"> </span><span class="nx">Bytes</span><span class="w">                                           </span><span class="nx">Ascii</span><span class="w">
                 </span><span class="mi">00</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">06</span><span class="w"> </span><span class="mi">07</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">09</span><span class="w"> </span><span class="mi">0</span><span class="n">A</span><span class="w"> </span><span class="nx">0B</span><span class="w"> </span><span class="nx">0C</span><span class="w"> </span><span class="nx">0D</span><span class="w"> </span><span class="nx">0E</span><span class="w"> </span><span class="nx">0F</span><span class="w">
          </span><span class="o">------</span><span class="w"> </span><span class="o">-----------------------------------------------</span><span class="w"> </span><span class="o">-----</span><span class="w">
</span><span class="mi">0000000000000000</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="mi">62</span><span class="w"> </span><span class="mi">75</span><span class="w"> </span><span class="mi">6</span><span class="n">E</span><span class="w"> </span><span class="nx">74</span><span class="w"> </span><span class="nx">75</span><span class="w"> </span><span class="nx">2D</span><span class="w"> </span><span class="nx">32</span><span class="w"> </span><span class="nx">34</span><span class="w"> </span><span class="nx">2E</span><span class="w"> </span><span class="nx">30</span><span class="w"> </span><span class="nx">34</span><span class="w">             </span><span class="nx">Ubuntu-24.04</span><span class="w">

</span><span class="nv">$defaultDistro</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Format-Hex</span><span class="w">

   </span><span class="n">Label:</span><span class="w"> </span><span class="nx">String</span><span class="w"> </span><span class="p">(</span><span class="n">System.String</span><span class="p">)</span><span class="w"> </span><span class="err">&lt;</span><span class="mi">45133834</span><span class="err">&gt;</span><span class="w">

          </span><span class="n">Offset</span><span class="w"> </span><span class="nx">Bytes</span><span class="w">                                           </span><span class="nx">Ascii</span><span class="w">
                 </span><span class="mi">00</span><span class="w"> </span><span class="mi">01</span><span class="w"> </span><span class="mi">02</span><span class="w"> </span><span class="mi">03</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">05</span><span class="w"> </span><span class="mi">06</span><span class="w"> </span><span class="mi">07</span><span class="w"> </span><span class="mi">08</span><span class="w"> </span><span class="mi">09</span><span class="w"> </span><span class="mi">0</span><span class="n">A</span><span class="w"> </span><span class="nx">0B</span><span class="w"> </span><span class="nx">0C</span><span class="w"> </span><span class="nx">0D</span><span class="w"> </span><span class="nx">0E</span><span class="w"> </span><span class="nx">0F</span><span class="w">
          </span><span class="o">------</span><span class="w"> </span><span class="o">-----------------------------------------------</span><span class="w"> </span><span class="o">-----</span><span class="w">
</span><span class="mi">0000000000000000</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">62</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">75</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">6</span><span class="n">E</span><span class="w"> </span><span class="nx">00</span><span class="w"> </span><span class="nx">74</span><span class="w"> </span><span class="nx">00</span><span class="w"> </span><span class="nx">75</span><span class="w"> </span><span class="nx">00</span><span class="w"> </span><span class="nx">2D</span><span class="w"> </span><span class="nx">00</span><span class="w"> </span><span class="nx">32</span><span class="w">  </span><span class="nx">U</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">2</span><span class="w">
</span><span class="mi">0000000000000010</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">34</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">2</span><span class="n">E</span><span class="w"> </span><span class="nx">00</span><span class="w"> </span><span class="nx">30</span><span class="w"> </span><span class="nx">00</span><span class="w"> </span><span class="nx">34</span><span class="w"> </span><span class="nx">00</span><span class="w">                       </span><span class="nx">4</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="nx">4</span><span class="w">
</span></code></pre></div></div>

<p>They look the same on the outside, but not on the inside. The following will do a brute force string replace to drop from UTF-16 to UTF-8</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$defaultDistro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$defaultDistro</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s1">'[\x00-\x1F\x7F-\x9F]'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s1">'\s+'</span><span class="p">,</span><span class="w"> </span><span class="s1">' '</span><span class="p">)</span><span class="o">.</span><span class="nf">Trim</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>
<p>In theory, uses UTF8.GetString would do the conversion, with syntax like this:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$rawBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">Default.GetBytes</span><span class="p">(</span><span class="nv">$defaultDistro</span><span class="p">)</span><span class="w">
</span><span class="nv">$defaultDistro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetString</span><span class="p">(</span><span class="nv">$rawBytes</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>But the null bytes remained, using <code class="language-plaintext highlighter-rouge">-replace</code> worked for me.</p>

<h3 id="getting-the-tar-name">Getting the TAR Name</h3>
<p>Now that we have the distro name all cleaned up, we need the name of the TAR file to be created. First we’ll create a function to make the name of the TAR file.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Get-ArchiveFileName</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$DistroName</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="c"># Get current date, formatted as YYYY-MM, and combine with distribution name</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Date</span><span class="p">)</span><span class="o">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s2">"yyyy-MM"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"-"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$DistroName</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Most of the code just validates that we passed in a non-empty value for <code class="language-plaintext highlighter-rouge">$DistroName</code> and the prepends the year and month. I’m not doing daily backups of the OS image, the data that changes is backed up.</p>

<p>Next, we’ll add a function to get a full path for the TAR file.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Get-TarArchivePath</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$ArchiveName</span><span class="w">
    </span><span class="p">)</span><span class="w">
    
    </span><span class="c"># Get the temp folder path and combine with archive name and .tar extension</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="n">Join-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TEMP</span><span class="w"> </span><span class="nt">-ChildPath</span><span class="w"> </span><span class="s2">"</span><span class="nv">$ArchiveName</span><span class="s2">.tar"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>That will take the name, put in the user temp folder, and add the “.tar” extension.</p>

<h3 id="generating-the-tar-file">Generating the TAR file</h3>
<p>Now we can add a function to export the distro to a TAR file</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Export-WSLDistribution</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$DistributionName</span><span class="p">,</span><span class="w">
        
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$ArchiveName</span><span class="w">
    </span><span class="p">)</span><span class="w">
    
    </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c"># Get the full tar path using the existing function</span><span class="w">
        </span><span class="nv">$tarPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-TarArchivePath</span><span class="w"> </span><span class="nt">-ArchiveName</span><span class="w"> </span><span class="nv">$ArchiveName</span><span class="w">
        
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Exporting WSL distribution '</span><span class="nv">$DistributionName</span><span class="s2">' to '</span><span class="nv">$tarPath</span><span class="s2">'..."</span><span class="w">
        
        </span><span class="c"># Execute wsl --export command</span><span class="w">
        </span><span class="nv">$result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wsl</span><span class="w"> </span><span class="nt">--export</span><span class="w"> </span><span class="nv">$DistributionName</span><span class="w"> </span><span class="nv">$tarPath</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="o">&amp;</span><span class="nx">1</span><span class="w">
        
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$LASTEXITCODE</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="kr">throw</span><span class="w"> </span><span class="s2">"WSL export for '</span><span class="nv">$DistributionName</span><span class="s2">' to '</span><span class="nv">$tarPath</span><span class="s2">' failed with exit code </span><span class="nv">$LASTEXITCODE</span><span class="s2">. Error: </span><span class="nv">$result</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
        
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">Test-Path</span><span class="w"> </span><span class="nv">$tarPath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Export completed successfully: </span><span class="nv">$tarPath</span><span class="s2">"</span><span class="w">
            </span><span class="kr">return</span><span class="w"> </span><span class="nv">$tarPath</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="kr">throw</span><span class="w"> </span><span class="s2">"Export appeared to succeed but tar file was not created at: </span><span class="nv">$tarPath</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Error</span><span class="w"> </span><span class="s2">"Failed to export WSL distribution '</span><span class="nv">$DistributionName</span><span class="s2">': </span><span class="si">$(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Exception</span><span class="o">.</span><span class="nf">Message</span><span class="si">)</span><span class="s2">"</span><span class="w">
        </span><span class="kr">throw</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>That code will call <code class="language-plaintext highlighter-rouge">Get-TarArchivePath</code> to get the full name of the TAR file and then call <code class="language-plaintext highlighter-rouge">wsl --export</code>. If successful, it will return the name of the TAR file.</p>

<h3 id="compressing-the-tar-name">Compressing the TAR Name</h3>
<p>The next step is to compress that TAR file. We don’t need a big uncompressed file, when a smaller one will do.  We have a function to do that as well.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Compress-WSLBackup</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$TarPath</span><span class="w">
    </span><span class="p">)</span><span class="w">
    
    </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c"># Get the zip path by changing the extension of the tar path to .7z</span><span class="w">
        </span><span class="nv">$zipPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.IO.Path</span><span class="p">]::</span><span class="n">ChangeExtension</span><span class="p">(</span><span class="nv">$TarPath</span><span class="p">,</span><span class="w"> </span><span class="s2">".7z"</span><span class="p">)</span><span class="w">
        
        </span><span class="c"># Need to use Start-Process to call 7z.exe, and wait for it to finish before checking if the file was created</span><span class="w">
        </span><span class="n">start-Process</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="s2">"C:\Program Files\7-Zip\7z.exe"</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="s2">"a"</span><span class="p">,</span><span class="w"> </span><span class="s2">"-t7z"</span><span class="p">,</span><span class="w"> </span><span class="nv">$zipPath</span><span class="p">,</span><span class="w"> </span><span class="nv">$TarPath</span><span class="w"> </span><span class="nt">-Wait</span><span class="w"> </span><span class="nt">-NoNewWindow</span><span class="w">
        
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="n">Test-Path</span><span class="w"> </span><span class="nv">$zipPath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Compression completed successfully: </span><span class="nv">$zipPath</span><span class="s2">"</span><span class="w">
            </span><span class="kr">return</span><span class="w"> </span><span class="nv">$zipPath</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="kr">throw</span><span class="w"> </span><span class="s2">"Compression appeared to succeed but 7-Zip file was not created at: </span><span class="nv">$zipPath</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Error</span><span class="w"> </span><span class="s2">"Failed to compress WSL backup: </span><span class="si">$(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Exception</span><span class="o">.</span><span class="nf">Message</span><span class="si">)</span><span class="s2">"</span><span class="w">
        </span><span class="kr">throw</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<h3 id="copying-the-compressed-file">Copying the compressed file</h3>
<p>If the compression works, the function will return the name of the compressed file. And we’ll use that file name to copy the file with the <code class="language-plaintext highlighter-rouge">Copy-Item</code> command</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$zipPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Compress-WSLBackup</span><span class="w"> </span><span class="nt">-TarPath</span><span class="w"> </span><span class="nv">$tarPath</span><span class="w">

</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$zipPath</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="nv">$Destination</span><span class="w">
</span></code></pre></div></div>

<h3 id="cleanup">Cleanup</h3>
<p>The last thing to add is some cleanup code to remove the files out of the temp folder.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Remove-OldWSLBackups</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$DistributionName</span><span class="w">
    </span><span class="p">)</span><span class="w">
    
    </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c"># Get first 2 digits of current year</span><span class="w">
        </span><span class="nv">$yearPrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Date</span><span class="p">)</span><span class="o">.</span><span class="nf">Year</span><span class="o">.</span><span class="nf">ToString</span><span class="p">()</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nx">2</span><span class="p">)</span><span class="w">
        
        </span><span class="c"># Build search patterns for both .tar and .7z files</span><span class="w">
        </span><span class="nv">$tarPattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$yearPrefix</span><span class="s2">*</span><span class="nv">$DistributionName</span><span class="s2">*.tar"</span><span class="w">
        </span><span class="nv">$zipPattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$yearPrefix</span><span class="s2">*</span><span class="nv">$DistributionName</span><span class="s2">*.7z"</span><span class="w">
        
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Searching for old backups matching patterns: </span><span class="nv">$tarPattern</span><span class="s2">, </span><span class="nv">$zipPattern</span><span class="s2">"</span><span class="w">
        
        </span><span class="c"># Get matching files in temp directory for both extensions</span><span class="w">
        </span><span class="nv">$tarBackups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TEMP</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="nv">$tarPattern</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
        </span><span class="nv">$zipBackups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TEMP</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="nv">$zipPattern</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
        
        </span><span class="c"># Combine both results</span><span class="w">
        </span><span class="nv">$oldBackups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="nv">$tarBackups</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">@(</span><span class="nv">$zipBackups</span><span class="p">)</span><span class="w">
        
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$oldBackups</span><span class="o">.</span><span class="nf">Count</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"No old backup files found to delete."</span><span class="w">
            </span><span class="kr">return</span><span class="w">
        </span><span class="p">}</span><span class="w">
        
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Found </span><span class="si">$(</span><span class="nv">$oldBackups</span><span class="o">.</span><span class="nf">Count</span><span class="si">)</span><span class="s2"> old backup file(s) to delete:"</span><span class="w">
        
        </span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$file</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$oldBackups</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"  Deleting: </span><span class="si">$(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="si">)</span><span class="s2">"</span><span class="w">
            </span><span class="n">Remove-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$file</span><span class="o">.</span><span class="nf">FullName</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">Stop</span><span class="w">
            </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"  Successfully deleted: </span><span class="si">$(</span><span class="nv">$file</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
        
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"Cleanup completed successfully."</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Error</span><span class="w"> </span><span class="s2">"Failed to remove old WSL backups: </span><span class="si">$(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Exception</span><span class="o">.</span><span class="nf">Message</span><span class="si">)</span><span class="s2">"</span><span class="w">
        </span><span class="kr">throw</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>And we call it with</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Remove-OldWSLBackups</span><span class="w"> </span><span class="nt">-DistributionName</span><span class="w"> </span><span class="nv">$defaultDistro</span><span class="w">
</span></code></pre></div></div>

<p>You can the entire PowerShell script from <a href="https://gist.github.com/anotherlab/0bfae255f41f87a83e31ec077bf3f606">here</a>. It has detailed comments to explain how to use it. It was tested on Windows 11, with PowerShell 7.5.4.  It does require 7-Zip, you can get that from <a href="https://www.7-zip.org/download.html">7-zip.org</a>. At the time this was written, there is a malware site masqurading as the official 7-Zip site.  Only use 7-zip.org. <a href="https://www.malwarebytes.com/blog/threat-intel/2026/02/fake-7-zip-downloads-are-turning-home-pcs-into-proxy-nodes">More info</a> about that malware.</p>

<h2 id="bonus-round-so-why-7-zip">Bonus Round: So why 7-ZIP?</h2>

<h3 id="some-background">Some background</h3>
<p>When you export a WSL image, you get a TAR file. TAR stands for <strong>T</strong>ape <strong>AR</strong>chive and is only of the oldest file archive formats. It’s how UNIX systems backed up data to tape. Ubuntu is a Linux distribution. While Linux is not Unix, it is a “Unix-like” operating system and implemented many of the Unix tools from teh dark times.</p>

<p>TAR does not compress the data. Tape was cheaper than memory, it was faster just stream the data to tape without compressing it. And it’s a standard format.</p>

<p>What TAR does do is backup Linux file permissions, symlinks, and metadata. You wont get that with Zip, RAR, or 7-Zip. To get the compression, you want to compress the data after the TAR file has been generated.</p>

<h3 id="compressing-files-in-powershell">Compressing files in PowerShell</h3>

<p>I played around with the usual suspects for compression. PowerShell has a <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.archive/compress-archive">Compress-Archive</a> command that will generate a zip.  For compressing a TAR file, that would look like this</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"'</span><span class="nv">$</span><span class="nn">ENV</span><span class="p">:</span><span class="nv">TEMP</span><span class="s2">'\something.tar"</span><span class="w">
</span><span class="nv">$dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"'</span><span class="nv">$</span><span class="nn">ENV</span><span class="p">:</span><span class="nv">TEMP</span><span class="s2">'\something.zip"</span><span class="w">
</span><span class="n">Compress-Archive</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$src</span><span class="w"> </span><span class="nt">-DestinationPath</span><span class="w"> </span><span class="nv">$dest</span><span class="w">
</span></code></pre></div></div>

<p>Another way to create ZIP files in PowerShell is making a .NET Framework call.  It’s usually a little faster than <code class="language-plaintext highlighter-rouge">Compress-Archive</code>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Add-Type</span><span class="w"> </span><span class="nt">-Assembly</span><span class="w"> </span><span class="s2">"System.IO.Compression.FileSystem"</span><span class="w">
</span><span class="p">[</span><span class="n">System.IO.Compression.ZipFile</span><span class="p">]::</span><span class="n">CreateFromDirectory</span><span class="p">(</span><span class="nv">$src</span><span class="p">,</span><span class="w"> </span><span class="nv">$dest</span><span class="p">,</span><span class="w"> </span><span class="s1">'Fastest'</span><span class="p">,</span><span class="w"> </span><span class="bp">$false</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>They worked, but there are better alternatives. My file archive tool of choice is <a href="https://www.7-zip.org/">7-Zip</a>. It gives you multiple compression options for the zip file format.  I used the best level of the faster compression settings, <code class="language-plaintext highlighter-rouge">-mx4</code>.  The better compression settings took so long, I canceled them.</p>

<p>The <code class="language-plaintext highlighter-rouge">-mx4</code> setting was fast enough and produced smaller. zip files than <code class="language-plaintext highlighter-rouge">Compress-Archive</code> and <code class="language-plaintext highlighter-rouge">System.IO.Compression.ZipFile</code>. Not by a large amount, maybe 5% smaller for my stuff.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-Alias</span><span class="w"> </span><span class="nx">sz</span><span class="w"> </span><span class="s2">"C:\Program Files\7-Zip\7z.exe"</span><span class="w">
</span><span class="n">sz</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nt">-mx</span><span class="o">=</span><span class="mi">4</span><span class="w"> </span><span class="nv">$dest</span><span class="w"> </span><span class="nv">$src</span><span class="w">
</span></code></pre></div></div>

<p>I then tried <a href="https://www.win-rar.com/">WinRAR</a> for both Zip and RAR formats. WinRAR is a great tool, but it’s not free.  If you own WinRAR and want to use it</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">set-alias</span><span class="w"> </span><span class="nx">sr</span><span class="w"> </span><span class="s2">"C:\Program Files\WinRAR\Rar.exe"</span><span class="w">
</span><span class="nv">$dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"'</span><span class="nv">$</span><span class="nn">ENV</span><span class="p">:</span><span class="nv">TEMP</span><span class="s2">'\something.rar"</span><span class="w">
</span><span class="n">sr</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nv">$dest</span><span class="w"> </span><span class="nv">$src</span><span class="w">
</span></code></pre></div></div>

<p>Since I’m using 7-ZIP, I decided to use it’s best format, the 7Zip format. At this point, as of 22H2 even Windows 11 can natively read 7Zip (in addition to Zip, RAR, TAR, and GZ) files.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-Alias</span><span class="w"> </span><span class="nx">sz</span><span class="w"> </span><span class="s2">"C:\Program Files\7-Zip\7z.exe"</span><span class="w">
</span><span class="nv">$dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"'</span><span class="nv">$</span><span class="nn">ENV</span><span class="p">:</span><span class="nv">TEMP</span><span class="s2">'\something.7z"</span><span class="w">
</span><span class="n">sz</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nt">-t7z</span><span class="w"> </span><span class="nv">$dest</span><span class="w"> </span><span class="nv">$src</span><span class="w">
</span></code></pre></div></div>
<h3 id="comparing-the-compression-options">Comparing the compression options</h3>

<p>The 7zip format had much better compression and speed than the Zip and RAR formats. My WSL image is named Ubuntu-24.04 and I ran this on February 17th. This table shows the files, sizes, and compression compared to the TAR file.  I didn’t need to set the <code class="language-plaintext highlighter-rouge">-mx</code> option.</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th style="text-align: right">Size (GB)</th>
      <th style="text-align: right">Percent from Largest</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2026-02-Ubuntu-24.04.tar</td>
      <td style="text-align: right">6.23</td>
      <td style="text-align: right">100.00%</td>
    </tr>
    <tr>
      <td>2026-02-Ubuntu-24.04.zip</td>
      <td style="text-align: right">2.15</td>
      <td style="text-align: right">34.57%</td>
    </tr>
    <tr>
      <td>2026-02-Ubuntu-24.04.rar</td>
      <td style="text-align: right">2.07</td>
      <td style="text-align: right">33.20%</td>
    </tr>
    <tr>
      <td>2026-02-Ubuntu-24.04.7z</td>
      <td style="text-align: right">1.51</td>
      <td style="text-align: right">24.21%</td>
    </tr>
  </tbody>
</table>

<p>ZIP and RAR went down to a third of the TAR size and were pretty close. The 7Z file was less a quarter of the original.</p>

<p>The PowerShell to generate that table was pretty simple:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get the matching files</span><span class="w">
</span><span class="nv">$files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TEMP</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="s2">"2026-*"</span><span class="w">

</span><span class="c"># Get the size of the largest file</span><span class="w">
</span><span class="nv">$maxLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">$files</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nx">Length</span><span class="w"> </span><span class="nt">-Descending</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-First</span><span class="w"> </span><span class="nx">1</span><span class="p">)</span><span class="o">.</span><span class="nf">Length</span><span class="w">

</span><span class="c"># Display as a table</span><span class="w">
</span><span class="nv">$files</span><span class="w"> </span><span class="o">|</span><span class="w">
  </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nx">Length</span><span class="w"> </span><span class="nt">-Descending</span><span class="w"> </span><span class="o">|</span><span class="w">
  </span><span class="n">Select-Object</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w">
    </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s2">"SizeGB"</span><span class="p">;</span><span class="nx">Expression</span><span class="o">=</span><span class="p">{[</span><span class="n">math</span><span class="p">]::</span><span class="n">Round</span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nx">1GB</span><span class="p">,</span><span class="w"> </span><span class="nx">2</span><span class="p">)}},</span><span class="w">
    </span><span class="p">@{</span><span class="nx">Name</span><span class="o">=</span><span class="s2">"PercentOfLargest"</span><span class="p">;</span><span class="nx">Expression</span><span class="o">=</span><span class="p">{</span><span class="w">
      </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$maxLength</span><span class="w"> </span><span class="o">-gt</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"{0:N2}%"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="p">((</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="n">/</span><span class="w"> </span><span class="nv">$maxLength</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">}}</span><span class="w"> </span><span class="o">|</span><span class="w">
  </span><span class="n">Format-Table</span><span class="w"> </span><span class="nt">-AutoSize</span><span class="w">
</span></code></pre></div></div>

<p>That made the choice of the 7Z format a non-brainer.  Even with today’s large drives, saving 4.5 GB is a lot.</p>]]></content><author><name>anotherlab</name></author><category term="WSL2" /><category term="PowerShell" /><category term="Backups" /><category term="WSL2" /><category term="Ubuntu" /><category term="PowerShell" /><category term="Backups" /><category term="Linux" /><summary type="html"><![CDATA[Backing up my main Linux session TL;DR: I wrote a PowerShell script named backup-wsl2.ps1 to backup a Linux distribution. You can run like this: .\backup-wsl2.ps1 -Destination "C:\Backups" You can grab it from here. It’s pretty long so I wont display it, but I will do a mini-teardown. [System.IO.Compression.ZipFile]::CreateFromDirectory($src, $dest, ‘Fastest’, $false)]]></summary></entry><entry><title type="html">UsbSerialForAndroid: Recent Updates and Improvements</title><link href="http://localhost:4000/2026/01/05/UsbSerialForAndroid-updates/" rel="alternate" type="text/html" title="UsbSerialForAndroid: Recent Updates and Improvements" /><published>2026-01-05T00:00:00+00:00</published><updated>2026-01-05T00:00:00+00:00</updated><id>http://localhost:4000/2026/01/05/UsbSerialForAndroid-updates</id><content type="html" xml:base="http://localhost:4000/2026/01/05/UsbSerialForAndroid-updates/"><![CDATA[<p>I’ve pushed a new round of updates to <strong><a href="https://github.com/anotherlab/UsbSerialForAndroid">UsbSerialForAndroid</a></strong>, the open-source .NET / C# library that provides USB serial support for Android, including .NET MAUI and Xamarin-based projects.</p>

<p>These changes focus on improving reliability, maintainability, and compatibility with modern .NET and Android tooling.</p>

<h2 id="whats-new">What’s New</h2>

<p>Recent updates include:</p>

<ul>
  <li>
    <p><strong>General code cleanup and modernization</strong><br />
The codebase has been updated to better align with current .NET and Android best practices, making it easier to maintain and extend.</p>
  </li>
  <li>
    <p><strong>Improved stability and error handling</strong><br />
Several edge cases around device connection, disconnection, and serial communication have been tightened up to reduce unexpected failures.</p>
  </li>
  <li>
    <p><strong>Compatibility improvements</strong><br />
Updates were made to ensure smoother integration with current versions of .NET for Android and .NET MAUI.</p>
  </li>
  <li>
    <p><strong>Documentation and project maintenance</strong><br />
README updates and project metadata improvements to make it clearer how to use the library and what environments are supported.</p>
  </li>
  <li>
    <p><strong>Nuget</strong><br />
Updates are now available on nuget. You no longer have to build the library to use it.</p>
  </li>
</ul>

<h2 id="breaking-changes">Breaking Changes</h2>
<p>This release supports .NET and drops support for previous versions. Including Xamarin. The last supported SDK by Xamarinwas API 34. As of August 31, 2025, the minimum API level allowed for Google Play apps is now API 35. If someone really wants to use this library with Xamarin.Android, they’ll have to use a <a href="https://github.com/anotherlab/UsbSerialForAndroid/releases/tag/v1.1.1">previous release</a>.</p>

<p>The code should work with .NET 8 or .NET 9, but I haven’t tested this update with the older versions. If you need to support .NET 8, the <a href="https://github.com/anotherlab/UsbSerialForAndroid/releases/tag/v1.1.1">previous release</a> should work.</p>

<p>With the release to nuget, I made a change the default namespace for the library. Someone created a nuget package based on a two year old version of this code base and published to nuget under their own name (and without credit to the original authors). I changed the root namespace from <code class="language-plaintext highlighter-rouge">Hoho.Android.UsbSerial</code> to <code class="language-plaintext highlighter-rouge">Anotherlab.UsbSerialForAndroid</code> to make it easier to manage on nuget.</p>

<p>The “Hoho” namespace came from original Java library package name, <a href="https://github.com/mik3y/usb-serial-for-android">usb-serial-for-android</a>, and while I based this code from that library, they are separate.</p>

<h2 id="what-can-you-do-with-this-library">What can you do with this library?</h2>

<p>UsbSerialForAndroid is often used in scenarios involving:</p>

<ul>
  <li>Hardware integration</li>
  <li>Industrial or diagnostic tools</li>
  <li>Embedded devices connected via USB OTG</li>
  <li>Cross-platform .NET applications targeting Android</li>
</ul>

<p>These updates aim to make those scenarios more reliable while keeping the API familiar for existing users.</p>

<h2 id="net-maui">.NET MAUI</h2>
<p>While this code is Android specific, it should work just fine for the Android target of a .NET MAUI app.</p>

<h2 id="get-the-updates">Get the Updates</h2>

<p>If you’re already using the library, I recommend pulling the latest changes or updating to the newest package version.</p>

<ul>
  <li>
    <p><strong>GitHub repository:</strong><br />
<a href="https://github.com/anotherlab/UsbSerialForAndroid">https://github.com/anotherlab/UsbSerialForAndroid</a></p>
  </li>
  <li>
    <p><strong>Issues and feedback:</strong><br />
Bug reports, feature requests, and pull requests are always welcome.</p>
  </li>
</ul>

<h2 id="nuget-package-availability">NuGet Package Availability</h2>
<p><img src="https://github.com/anotherlab/UsbSerialForAndroid/raw/main/UsbSerialForAndroid/icon.png" alt="Logo" /></p>

<p><a href="https://www.nuget.org/packages/UsbSerialForAndroid"><img src="https://img.shields.io/nuget/v/usbserialforandroid?style=flat-square" alt="NuGet version (usbserialforandroid)" /></a></p>

<p>The library can now be added directly via <a href="https://www.nuget.org/packages/UsbSerialForAndroid">NuGet</a>, eliminating the need to manually reference source projects or maintain forks.</p>

<p>This improves:</p>

<ul>
  <li>Dependency management</li>
  <li>Versioning and upgrades</li>
  <li>CI/CD and reproducible builds</li>
  <li>Integration with .NET MAUI and modern SDK-style projects</li>
</ul>

<p>NuGet availability also makes it easier to consume UsbSerialForAndroid alongside other Android and cross-platform dependencies.</p>

<h2 id="background">Background</h2>
<p>This is a project that I have been maintaining on and off for a number of years. We have an application that runs on Android and it needed to communicate with an RFID reader. The reader supports serial communication over USB. At the time, our application was written with Xamarin.Android and it didn’t have much for USB Serial communnication support.</p>

<p>I found a really good open soource library written in Java called <a href="https://github.com/mik3y/usb-serial-for-android">usb-serial-for-android</a>. I ported it to C# more or less line by line. There are differences in the code bases, Java and C# are similar, but not identical. After completing the port from Java to C#, I obtained permission from my employer to make this an open-source library.</p>

<h2 id="thanks">Thanks</h2>

<p>Thanks to everyone who has starred the repo, filed issues, or contributed fixes. Open-source feedback is what keeps this project useful and moving forward.</p>

<p>If you’re using UsbSerialForAndroid in a project, I’d love to hear how it’s working for you.</p>]]></content><author><name>anotherlab</name></author><category term=".NET" /><category term="Android" /><category term="Hardware" /><category term=".NET" /><category term="Android" /><category term=".NET MAUI" /><category term="USB" /><category term="Open Source" /><summary type="html"><![CDATA[I’ve pushed a new round of updates to UsbSerialForAndroid, the open-source .NET / C# library that provides USB serial support for Android, including .NET MAUI and Xamarin-based projects.]]></summary></entry><entry><title type="html">How to force Visual Studio to update the debug device for a MAUI project</title><link href="http://localhost:4000/2025/11/16/hacking-csproj-user/" rel="alternate" type="text/html" title="How to force Visual Studio to update the debug device for a MAUI project" /><published>2025-11-16T00:00:00+00:00</published><updated>2025-11-16T00:00:00+00:00</updated><id>http://localhost:4000/2025/11/16/hacking-csproj-user</id><content type="html" xml:base="http://localhost:4000/2025/11/16/hacking-csproj-user/"><![CDATA[<p>When I’m writing code for .NET MAUI in Visual Studio, I often use actual devices. I’m working on a app that uses BLE and you really can’t test that with an emulator. And I usually test with a wired ADB connection. If you in the middle of working in VS and you unplug your Android device, VS will change the current debugging target from your device to the last used emulator. When you plug your device back in, it does not switch back to your device.</p>

<p>I’ll walk awa from my desk and I’ll take my phone with me. When I come back, I’ll plug the phone, but forget to change the device in Visual Studio back to my phone. I’ll make a code change and then start debugging the app. Cue up a <a href="https://screenrant.com/star-trek-tng-picard-riker-facepalm-popular-meme-why/">Picard facepalm</a> as Visual Studio starts up an Android emulator.</p>

<p>I wanted to short circuit this behavior.</p>

<p>The JetBrains IDEs like Android Studio and Rider will switch back to your device when you plug it back in. This is how it should be. I don’t know if this is a design decision by the VS team or just an ommision. I have <a href="https://developercommunity.visualstudio.com/t/Feature-Request:-Remember-Last-Selected/10933798">reported this to the VS team</a>, but that went nowhere.</p>

<p>Visual Studio doesn’t provide a keyboard shortcut to quickly select the Android device for debugging. And I didn’t want to write a VS extension to go deep under the hood. Maybe someday, just not now. That would have been a little too much <a href="https://www.youtube.com/shorts/eDVsjUxaD6g">yak shaving</a> for this week.</p>

<p>The setting of the current delected debug device is written to the csproj user file. This file has the same name as the project, but with “.user” tacked on the end.</p>

<p>When my Samsung phone is attached and has been selected as the debug device, the project.csproj.user will look something like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;Project</span> <span class="na">ToolsVersion=</span><span class="s">"Current"</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/developer/msbuild/2003"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;IsFirstTimeProjectOpen&gt;</span>False<span class="nt">&lt;/IsFirstTimeProjectOpen&gt;</span>
    <span class="nt">&lt;ActiveDebugFramework&gt;</span>net10.0-android<span class="nt">&lt;/ActiveDebugFramework&gt;</span>
    <span class="nt">&lt;ActiveDebugProfile&gt;</span>Samsung SM-S908U (Android 16.0 - API 36)<span class="nt">&lt;/ActiveDebugProfile&gt;</span>
    <span class="nt">&lt;SelectedPlatformGroup&gt;</span>PhysicalDevice<span class="nt">&lt;/SelectedPlatformGroup&gt;</span>
    <span class="nt">&lt;DefaultDevice&gt;</span>pixel_9_-_api_36<span class="nt">&lt;/DefaultDevice&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
  <span class="nt">&lt;PropertyGroup</span> <span class="na">Condition=</span><span class="s">"'$(TargetPlatformIdentifier)'=='iOS'"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;RuntimeIdentifier&gt;</span>iossimulator-x64<span class="nt">&lt;/RuntimeIdentifier&gt;</span>
    <span class="nt">&lt;PlatformTarget&gt;</span>x64<span class="nt">&lt;/PlatformTarget&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
  <span class="nt">&lt;ItemGroup</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div></div>

<p>For the rest of this article, I’m only going to show the property group with the settings that we want work with. And Visual Studio 2026 is open for this project.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;Project</span> <span class="na">ToolsVersion=</span><span class="s">"Current"</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/developer/msbuild/2003"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;ActiveDebugProfile&gt;</span>Samsung SM-S908U (Android 16.0 - API 36)<span class="nt">&lt;/ActiveDebugProfile&gt;</span>
    <span class="nt">&lt;SelectedPlatformGroup&gt;</span>PhysicalDevice<span class="nt">&lt;/SelectedPlatformGroup&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div></div>

<p>When I unplug my phone, after a second or two, the values in the csproj.user change to this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;Project</span> <span class="na">ToolsVersion=</span><span class="s">"Current"</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/developer/msbuild/2003"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;PropertyGroup&gt;</span>
    <span class="nt">&lt;ActiveDebugProfile&gt;</span>Pixel 9 - API 36 (Android 16.0 - API 36)<span class="nt">&lt;/ActiveDebugProfile&gt;</span>
    <span class="nt">&lt;SelectedPlatformGroup&gt;</span>Emulator<span class="nt">&lt;/SelectedPlatformGroup&gt;</span>
  <span class="nt">&lt;/PropertyGroup&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div></div>
<p>The “Pixel 9 - AP^ 36” is the name of the emulator image that I have been using lately.</p>

<p>The value of the <code class="language-plaintext highlighter-rouge">ActiveDebugProfile</code> element is the device that we want to change. The <code class="language-plaintext highlighter-rouge">SelectedPlatformGroup element</code> tells us if this real or virtual device.</p>

<h1 id="updates-are-live">Updates are live</h1>
<p>I found that if I edited the csproj.user outside of Visual Studio, those changes would be recognized by Visual Studio witbin a second or two.</p>

<p>Cool, I can work with that.</p>

<h1 id="hack-the-user-file">Hack the .user file</h1>
<p>There are any number of ways of making changes to an XML file.  I like PowerShell for this kind of stuff.  I wrote a little script named <a href="https://gist.github.com/anotherlab/57de44266e0b16f1987dd82d4bb5bcc5">update-phone.ps1</a> and it looks like this</p>

<script src="https://gist.github.com/57de44266e0b16f1987dd82d4bb5bcc5.js"> </script>

<h1 id="break-down-the-script">Break down the script</h1>
<p>The first few lines are just the usual parameter stuff, nothing to explain here.</p>

<p>Looking at the next block…</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Locate the .csproj.user file if not specified</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="nv">$CsprojUserFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$foundFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nt">-Filter</span><span class="w"> </span><span class="o">*.</span><span class="nf">csproj</span><span class="o">.</span><span class="nf">user</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-First</span><span class="w"> </span><span class="nx">1</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="nv">$foundFile</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Error</span><span class="w"> </span><span class="s2">"❌ No .csproj.user file found in the current directory."</span><span class="w">
        </span><span class="kr">exit</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="nv">$CsprojUserFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$foundFile</span><span class="o">.</span><span class="nf">FullName</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>If you don’t specify a .csproj.user file, the script will check the current folder and pick the first .csproj.user that it finds.</p>

<p>Next, we resolve the full path to the file that was passed in or located.</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Resolve to an absolute, full path</span><span class="w">
</span><span class="nv">$fullPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Resolve-Path</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$csprojUserFile</span><span class="p">)</span><span class="o">.</span><span class="nf">Path</span><span class="w">

</span><span class="c"># Load XML</span><span class="w">
</span><span class="nv">$xmlContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$fullPath</span><span class="w"> </span><span class="nt">-Raw</span><span class="w">
</span><span class="p">[</span><span class="n">xml</span><span class="p">]</span><span class="nv">$xml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xmlContent</span><span class="w">
</span></code></pre></div></div>
<p>PowerShell has a lovely little quirk where if you try to write to a file without a path or using a relative path, it will write to the “home” folder. By getting the full path to the file, you force it to write back to the correct folder.</p>

<p>Then we read the file and cast it to a XML data type.</p>

<p>Going back the original file, the XML is using a namespace and we need to account for it.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Project</span> <span class="na">ToolsVersion=</span><span class="s">"Current"</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/developer/msbuild/2003"</span><span class="nt">&gt;</span>
</code></pre></div></div>
<p>When you query XML with XPath, you need to factor in the namespace, so we’ll define it next:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Detect the MSBuild namespace if present</span><span class="w">
</span><span class="nv">$nsUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xml</span><span class="o">.</span><span class="nf">Project</span><span class="o">.</span><span class="nf">NamespaceURI</span><span class="w">
</span><span class="nv">$hasNamespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-not</span><span class="w"> </span><span class="p">[</span><span class="n">string</span><span class="p">]::</span><span class="n">IsNullOrWhiteSpace</span><span class="p">(</span><span class="nv">$nsUri</span><span class="p">)</span><span class="w">

</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$hasNamespace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$nsMgr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Xml.XmlNamespaceManager</span><span class="p">(</span><span class="nv">$xml</span><span class="o">.</span><span class="nf">NameTable</span><span class="p">)</span><span class="w">
    </span><span class="nv">$nsMgr</span><span class="o">.</span><span class="nf">AddNamespace</span><span class="p">(</span><span class="s2">"msb"</span><span class="p">,</span><span class="w"> </span><span class="nv">$nsUri</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>This reads in the URL of the namespace, “http://schemas.microsoft.com/developer/msbuild/2003”, and names it as “msb”.</p>

<p>With the namespace defined, we can search for the  <code class="language-plaintext highlighter-rouge">ActiveDebugProfile</code> element with a nicely formatted XPath query string that incorporates the namespace.</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Find the ActiveDebugProfile element</span><span class="w">
</span><span class="nv">$node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$xml</span><span class="o">.</span><span class="nf">SelectSingleNode</span><span class="p">(</span><span class="s2">"//msb:Project/msb:PropertyGroup/msb:ActiveDebugProfile"</span><span class="p">,</span><span class="w"> </span><span class="nv">$nsMgr</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>If we find that element, we can update it and write it back out.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c"># Set the device name</span><span class="w">
    </span><span class="nv">$node</span><span class="o">.</span><span class="nf">InnerText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$NewProfileValue</span><span class="w">

    </span><span class="c"># Then force it to physical device. If VS is open, it should do this anyways, but just in case.</span><span class="w">
    </span><span class="nv">$node2</span><span class="w"> </span><span class="o">=</span><span class="w"> 
      </span><span class="nv">$xml</span><span class="o">.</span><span class="nf">SelectSingleNode</span><span class="p">(</span><span class="s2">"//msb:Project/msb:PropertyGroup/msb:SelectedPlatformGroup"</span><span class="p">,</span><span class="w"> </span><span class="nv">$nsMgr</span><span class="p">)</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$node2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$node2</span><span class="o">.</span><span class="nf">InnerText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"PhysicalDevice"</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="c"># Save back to file with UTF-8 encoding</span><span class="w">
    </span><span class="nv">$utf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Text.UTF8Encoding</span><span class="p">(</span><span class="bp">$false</span><span class="p">)</span><span class="w">
    </span><span class="nv">$writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.IO.StreamWriter</span><span class="p">(</span><span class="nv">$fullPath</span><span class="p">,</span><span class="w"> </span><span class="bp">$false</span><span class="p">,</span><span class="w"> </span><span class="nv">$utf8</span><span class="p">)</span><span class="w">
    </span><span class="nv">$xml</span><span class="o">.</span><span class="nf">Save</span><span class="p">(</span><span class="nv">$writer</span><span class="p">)</span><span class="w">
    </span><span class="nv">$writer</span><span class="o">.</span><span class="nf">Close</span><span class="p">()</span><span class="w">    

    </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"ActiveDebugProfile updated to '</span><span class="nv">$NewProfileValue</span><span class="s2">'"</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nv">$csprojUserFile</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"ActiveDebugProfile element not found in the XML."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>After updating ActiveDebugProfile, we then update <code class="language-plaintext highlighter-rouge">SelectedPlatformGroup</code>. While testing, updating <code class="language-plaintext highlighter-rouge">SelectedPlatformGroup</code> wasn’t needed. Visual Studio will update it on it’s own. So that code could probably be removed.</p>

<p>Then we write it back to the original file. Forcing the UTF-8 encoding was a bit of overkill.  <code class="language-plaintext highlighter-rouge">$xml.Save($fullPatj)</code> probably would have been sufficient.</p>

<h1 id="running-the-scripts">Running the scripts</h1>
<p>To run the script you pass in the name of the device and the name of the .csproj file.</p>

<p>If you have a PowerShell session open in the project folder, the following syntax will work:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">d:\scripts\use-phone.ps1</span><span class="w"> </span><span class="s1">'Samsung SM-S908U'</span><span class="w">
</span></code></pre></div></div>
<p>Or use the full path:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">d:\scripts\use-phone.ps1</span><span class="w"> </span><span class="s1">'Samsung SM-S908U'</span><span class="w"> </span><span class="nx">E:\path-to-my-project\MyProject.csproj.user</span><span class="w">
</span></code></pre></div></div>
<p>Replace <code class="language-plaintext highlighter-rouge">d:\scripts\</code> with the path to your copy of the script.</p>

<p>I have a <a href="https://www.elgato.com/us/en/s/explore-stream-deck">Stream Deck</a> and I have a button mapped to run the script with the device and path. That allows me to just tap that button when I plug the phone in. If you want to easily run PowerShell scripts from a Stream Deck, take a look at the <a href="https://marketplace.elgato.com/product/scriptdeck-927e59aa-b42d-4da7-84cc-8c78f4dd7e18">ScriptDeck plugin</a>. I love the Stream Deck. It’s a giant macro pad that is application specific.</p>

<p>I wrote these scripts for PowerShell 7.5, but it should work for most versions.</p>]]></content><author><name>anotherlab</name></author><category term="VisualStudio" /><category term="MAUI" /><category term="Android" /><category term="PowerShell" /><category term="hacks, XML" /><summary type="html"><![CDATA[When I’m writing code for .NET MAUI in Visual Studio, I often use actual devices. I’m working on a app that uses BLE and you really can’t test that with an emulator. And I usually test with a wired ADB connection. If you in the middle of working in VS and you unplug your Android device, VS will change the current debugging target from your device to the last used emulator. When you plug your device back in, it does not switch back to your device.]]></summary></entry><entry><title type="html">Using PowerShell to convert VTT to SRT</title><link href="http://localhost:4000/2025/04/18/vtt-2-srt/" rel="alternate" type="text/html" title="Using PowerShell to convert VTT to SRT" /><published>2025-04-18T00:00:00+00:00</published><updated>2025-04-18T00:00:00+00:00</updated><id>http://localhost:4000/2025/04/18/vtt-2-srt</id><content type="html" xml:base="http://localhost:4000/2025/04/18/vtt-2-srt/"><![CDATA[<h1 id="converting-between-vtt-and-srt">Converting between VTT and SRT</h1>
<p>So I have to convert between VTT and SRT a few times a year. I’m lazy and forgetful so I decided to script the tasks with PowerShell.</p>

<p>We have a quarterly developer conference at work. With 7500+ employees, we do 4-5 tracks of 3-4 sessions each. Like everything else these days, it’s a virtual conference and is presented through Microsoft Teams. The sessions are recorded and we are building up a library as a reference. And yes, <a href="https://www.tylertech.com/careers/job-openings">we are hiring</a>.</p>

<p>When we get the videos from Teams, we also get a caption file, in VTT format. We have employees who are hearing impaired and they make use of closed captions. When you have a session with multiple presenters, Teams ability to tag the speaker’s name to the text is very helpful for the viewers. That alone makes it worthwhile to use the caption files instead of captioning in realtime as the viewer watches the video.</p>

<p>VTT is the shortened version of <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebVTT_API">WebVTT</a>, which stands for Web Video Text to Track File. It’s a W3C standard and is designed so that it can be used by web browsers. It’s a flexible format that supports a lot of functionality.</p>

<p>I on the team that puts on the conference and one of my tasks is to clean up the videos. I’ll go in and trim off leading and trailing dead time on each video. Some presenters will trigger the recording 5, 10, even 15 minutes before the session starts.</p>

<p>When you trim the video, you have to make sure the caption file is also edited. Otherwise the timestamps will be off. The presenter will say “Hello” and the caption would show up minutes later.</p>

<p>My tool for editing the videos is Adobe Premiere. I have it and I know enough about how to use it that I can make quick work of trimming the videos. After I edit the video, I submit it to Adobe’s batch encoder and move to the next video while the last one is being rendered.</p>

<p>Premiere doesn’t recognize VTT files. Or at least, I couldn’t get it recognize them. Premire uses the old <a href="https://docs.fileformat.com/video/srt/">SRT</a> format. SRT (SubRip Text) was the format used by SubRip, a program that could scan rendered videos and extract subtitles from them.</p>

<h2 id="the-formats">The formats</h2>
<p>The VTT and SRT formats are similar, but not interchangable.</p>

<table>
  <thead>
    <tr>
      <th>VTT</th>
      <th>SRT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>WEBVTT</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>1</td>
    </tr>
    <tr>
      <td>00:00.000 –&gt; 00:00.900</td>
      <td>00:00:00,000 –&gt; 00:00:00,900</td>
    </tr>
    <tr>
      <td>Some dialog here</td>
      <td>Some dialog here</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>2</td>
    </tr>
    <tr>
      <td>00:05:16.400 –&gt; 00:05:25.300</td>
      <td>00:05:16,400 –&gt; 00:05:25,300</td>
    </tr>
    <tr>
      <td>This is an example of</td>
      <td>This is an example of</td>
    </tr>
    <tr>
      <td>a subtitle - 2nd subtitle.</td>
      <td>a subtitle - 2nd subtitle.</td>
    </tr>
  </tbody>
</table>

<p>I would need to convert the VTT files to SRT, make the edits, then convert the edited SRT files to VTT. In addition to the format conversion, I was going to make a formatting change.</p>

<p>The VTT files generated by Teams use HTML like formatting to take the speaker name. It uses both of the following formats:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;v</span> <span class="na">LastName</span><span class="err">,</span> <span class="na">Firstname</span><span class="nt">&gt;</span>Spoken dialog goes here, could have a comma and the <span class="ni">&amp;amp;</span> would be escaped<span class="nt">&lt;/v&gt;</span>
<span class="nt">&lt;v</span> <span class="na">Firstname</span> <span class="na">Lastname</span><span class="nt">&gt;</span>Spoken dialog goes here, could have a comma and the <span class="ni">&amp;amp;</span> would be escaped<span class="nt">&lt;/v&gt;</span>
</code></pre></div></div>
<p>That is how the text would appear if you played the video back with an app like. VLC. We decided to change that to look like</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LastName, Firstname: Spoken dialog goes here, could have a comma and the &amp; would be escaped
Firstname Lastname: Spoken dialog goes here, could have a comma and the &amp; would be escaped
</code></pre></div></div>

<h1 id="powershell-to-the-rescue">PowerShell to the rescue</h1>
<p>I wrote a pair of PowerShell scripts to convert from VTT to SRT and back again. The VTT to SRT conversion would also handle the<code class="language-plaintext highlighter-rouge">&lt;v&gt;</code> tags.</p>

<h2 id="converting-vtt-to-srt">Converting VTT to SRT</h2>
<script src="https://gist.github.com/3067de2646f2278930c35fddfdfa52d3.js"> </script>

<p>This is the part of the post where I walk through the code. I commented the PowerShell code and it’s all simple. Both scripts are available as GitHub Gist links.</p>

<h3 id="closer-look">Closer look</h3>
<p>Let’s take a close look at the Updaye-NameFormat function:</p>

<div class="language-posh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">function</span><span class="w"> </span><span class="nf">Update-NameFormat</span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="bp">$input</span><span class="n">String</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="nv">$vpattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"^&lt;v "</span><span class="w">
    </span><span class="nv">$trailingPattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;/v&gt;$"</span><span class="w">

    </span><span class="c"># Does the string start with &lt;v ?</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="bp">$input</span><span class="n">String</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="nv">$vpattern</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c"># Remove the &lt;v&gt; tag</span><span class="w">
        </span><span class="nv">$outputString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$input</span><span class="n">String</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="nv">$vpattern</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="w">

        </span><span class="c"># look for the closing part of &lt;v&gt; tag</span><span class="w">
        </span><span class="nv">$index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$outputString</span><span class="o">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="s1">'&gt;'</span><span class="p">)</span><span class="w">
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$index</span><span class="w"> </span><span class="o">-ge</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nv">$outputString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$outputString</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$index</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">": "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$outputString</span><span class="o">.</span><span class="nf">Substring</span><span class="p">(</span><span class="nv">$index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">1</span><span class="p">)</span><span class="w">
        </span><span class="p">}</span><span class="w">        

    </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$outputString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$input</span><span class="n">String</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="c"># Remove any trailing &lt;/v&gt;</span><span class="w">
    </span><span class="nv">$outputString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$outputString</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="nv">$trailingPattern</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="w">

    </span><span class="c"># Decode HTML entities</span><span class="w">
    </span><span class="nv">$outputString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Convert-HtmlEntities</span><span class="w"> </span><span class="nt">-inputString</span><span class="w"> </span><span class="nv">$outputString</span><span class="w">

    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$outputString</span><span class="o">.</span><span class="nf">Trim</span><span class="p">()</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>In the Update-NameFormat function, I have the code that replaces the <code class="language-plaintext highlighter-rouge">&lt;v&gt;&lt;/v&gt;</code> tages. I tried doing the <code class="language-plaintext highlighter-rouge">&lt;v&gt;</code> replacements wiuth just RegEx, but getting it to match commas and spaces for the name separators made the code clunkly. I love a good RegEx, but I prefer simple code that I can read 6 months from now and still understand.</p>

<p>Instead of matching on the <code class="language-plaintext highlighter-rouge">&lt;v Last, First&gt;</code> or <code class="language-plaintext highlighter-rouge">&lt;v First last&gt;</code> patterns, I broke it and add partial matches and replacements. With the code below, I look for <code class="language-plaintext highlighter-rouge">~&lt;v&gt;</code>, which matches “&lt;v” at the start of the line. If a match is found, it’s removed. Then we look the first occurence of “&gt;” and replace it with “: “. Finally, we do a RegEx replacement for the <code class="language-plaintext highlighter-rouge">&lt;/v&gt;</code> pattern.</p>

<h1 id="converting-srt-back-to-vtt">Converting SRT back to VTT</h1>

<p>With the caption files in SRT format, I can load the video and the caption file into Premiere. When I trim off the video, Premiere updates the timestamps in the caption file. When I’m done, I just need to convert the SRT files to VTT.</p>

<p>The script to convert SRT to VTT is simpler. Since it’s not doing any <code class="language-plaintext highlighter-rouge">&lt;v&gt;</code> replacements or HTML decoding, it’s “read a line, write a line”.</p>

<script src="https://gist.github.com/7f3a82639ead91a55cfbd19ec474f3f1.js"> </script>

<h1 id="running-the-scripts">Running the scripts</h1>

<p>To run either script, you just pass the file name in. Can be an exact match or you can use wildcards. I wrote these scripts for Windows, using PowerShell 7.5.0. It should work on other platforms with any recent version of PowerShell.</p>]]></content><author><name>anotherlab</name></author><category term="powershell" /><category term="conversion" /><summary type="html"><![CDATA[Converting between VTT and SRT So I have to convert between VTT and SRT a few times a year. I’m lazy and forgetful so I decided to script the tasks with PowerShell. We have a quarterly developer conference at work. With 7500+ employees, we do 4-5 tracks of 3-4 sessions each. Like everything else these days, it’s a virtual conference and is presented through Microsoft Teams. The sessions are recorded and we are building up a library as a reference. And yes, we are hiring. When we get the videos from Teams, we also get a caption file, in VTT format. We have employees who are hearing impaired and they make use of closed captions. When you have a session with multiple presenters, Teams ability to tag the speaker’s name to the text is very helpful for the viewers. That alone makes it worthwhile to use the caption files instead of captioning in realtime as the viewer watches the video. VTT is the shortened version of WebVTT, which stands for Web Video Text to Track File. It’s a W3C standard and is designed so that it can be used by web browsers. It’s a flexible format that supports a lot of functionality. I on the team that puts on the conference and one of my tasks is to clean up the videos. I’ll go in and trim off leading and trailing dead time on each video. Some presenters will trigger the recording 5, 10, even 15 minutes before the session starts. When you trim the video, you have to make sure the caption file is also edited. Otherwise the timestamps will be off. The presenter will say “Hello” and the caption would show up minutes later. My tool for editing the videos is Adobe Premiere. I have it and I know enough about how to use it that I can make quick work of trimming the videos. After I edit the video, I submit it to Adobe’s batch encoder and move to the next video while the last one is being rendered. Premiere doesn’t recognize VTT files. Or at least, I couldn’t get it recognize them. Premire uses the old SRT format. SRT (SubRip Text) was the format used by SubRip, a program that could scan rendered videos and extract subtitles from them. The formats The VTT and SRT formats are similar, but not interchangable. VTT SRT WEBVTT     1 00:00.000 –&gt; 00:00.900 00:00:00,000 –&gt; 00:00:00,900 Some dialog here Some dialog here       2 00:05:16.400 –&gt; 00:05:25.300 00:05:16,400 –&gt; 00:05:25,300 This is an example of This is an example of a subtitle - 2nd subtitle. a subtitle - 2nd subtitle. I would need to convert the VTT files to SRT, make the edits, then convert the edited SRT files to VTT. In addition to the format conversion, I was going to make a formatting change. The VTT files generated by Teams use HTML like formatting to take the speaker name. It uses both of the following formats: &lt;v LastName, Firstname&gt;Spoken dialog goes here, could have a comma and the &amp;amp; would be escaped&lt;/v&gt; &lt;v Firstname Lastname&gt;Spoken dialog goes here, could have a comma and the &amp;amp; would be escaped&lt;/v&gt; That is how the text would appear if you played the video back with an app like. VLC. We decided to change that to look like LastName, Firstname: Spoken dialog goes here, could have a comma and the &amp; would be escaped Firstname Lastname: Spoken dialog goes here, could have a comma and the &amp; would be escaped PowerShell to the rescue I wrote a pair of PowerShell scripts to convert from VTT to SRT and back again. The VTT to SRT conversion would also handle the&lt;v&gt; tags. Converting VTT to SRT This is the part of the post where I walk through the code. I commented the PowerShell code and it’s all simple. Both scripts are available as GitHub Gist links. Closer look Let’s take a close look at the Updaye-NameFormat function: function Update-NameFormat{ param ( [string]$inputString ) $vpattern = "^&lt;v " $trailingPattern = "&lt;/v&gt;$" # Does the string start with &lt;v ? if ($inputString -match $vpattern) { # Remove the &lt;v&gt; tag $outputString = $inputString -replace $vpattern, '' # look for the closing part of &lt;v&gt; tag $index = $outputString.IndexOf('&gt;') if ($index -ge 0) { $outputString = $outputString.Substring(0, $index) + ": " + $outputString.Substring($index + 1) } } else { $outputString = $inputString } # Remove any trailing &lt;/v&gt; $outputString = $outputString -replace $trailingPattern, '' # Decode HTML entities $outputString = Convert-HtmlEntities -inputString $outputString return $outputString.Trim() } In the Update-NameFormat function, I have the code that replaces the &lt;v&gt;&lt;/v&gt; tages. I tried doing the &lt;v&gt; replacements wiuth just RegEx, but getting it to match commas and spaces for the name separators made the code clunkly. I love a good RegEx, but I prefer simple code that I can read 6 months from now and still understand. Instead of matching on the &lt;v Last, First&gt; or &lt;v First last&gt; patterns, I broke it and add partial matches and replacements. With the code below, I look for ~&lt;v&gt;, which matches “&lt;v” at the start of the line. If a match is found, it’s removed. Then we look the first occurence of “&gt;” and replace it with “: “. Finally, we do a RegEx replacement for the &lt;/v&gt; pattern. Converting SRT back to VTT With the caption files in SRT format, I can load the video and the caption file into Premiere. When I trim off the video, Premiere updates the timestamps in the caption file. When I’m done, I just need to convert the SRT files to VTT. The script to convert SRT to VTT is simpler. Since it’s not doing any &lt;v&gt; replacements or HTML decoding, it’s “read a line, write a line”. Running the scripts To run either script, you just pass the file name in. Can be an exact match or you can use wildcards. I wrote these scripts for Windows, using PowerShell 7.5.0. It should work on other platforms with any recent version of PowerShell.]]></summary></entry><entry><title type="html">Command for keeping your phone awake while plugged in</title><link href="http://localhost:4000/2025/04/13/adb-stay-on/" rel="alternate" type="text/html" title="Command for keeping your phone awake while plugged in" /><published>2025-04-13T00:00:00+00:00</published><updated>2025-04-13T00:00:00+00:00</updated><id>http://localhost:4000/2025/04/13/adb-stay-on</id><content type="html" xml:base="http://localhost:4000/2025/04/13/adb-stay-on/"><![CDATA[<p><img src="/assets/images/steampunk-robot-with-phone.jpg" alt="Automating the settings" /></p>

<p>Usually when I’m writing .NET MAUI code for Android, I use an emulator to test the code. It’s fast and there are fewer things that can go wrong. And most of time it’s good enough.</p>

<p>When you need to access something hardware related, you want real hardware. I’m working on stuff that uses BLE and you can’t really test with an emulator. You need the real deal. So I’ll use my phone.</p>

<p>One annoyance of using a real device is that it will turn the screen off after X minutes of inactivity. Usually just before you want to test some code. There is a setting that you can change to override this.</p>

<p>If you go to Developer Options, under settings, there should be a setting named <a href="https://developer.android.com/studio/debug/dev-options#general">“Stay awake”</a>. You need to have developer mode enabled, but if you are writing Android apps you already know that.</p>

<p><img src="/assets/images/developer-options.png" alt="Developer Options" /></p>

<p>I’m lazy and I hate having to dig through options. This is something that you can do through the command line. You can enable the stay awake session with the following <a href="https://developer.android.com/tools/adb">adb</a> command:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">settings</span><span class="w"> </span><span class="nx">put</span><span class="w"> </span><span class="nx">global</span><span class="w"> </span><span class="nx">stay_on_while_plugged_in</span><span class="w"> </span><span class="nx">3</span></code></pre></figure>

<p>And to turn it, do the following:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">settings</span><span class="w"> </span><span class="nx">put</span><span class="w"> </span><span class="nx">global</span><span class="w"> </span><span class="nx">stay_on_while_plugged_in</span><span class="w"> </span><span class="nx">0</span></code></pre></figure>

<p>To get the current status, use this</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">adb</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">settings</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">global</span><span class="w"> </span><span class="nx">stay_on_while_plugged_in</span></code></pre></figure>

<p>To make this even <del>lazier</del> easier for me, I added a pair of functions to my PowerShell profile.</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">adb-stay-on</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="o">.</span><span class="nv">${Env:ProgramFiles(x86)}</span><span class="n">\Android\android-sdk\platform-tools\adb.exe</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">settings</span><span class="w"> </span><span class="nx">put</span><span class="w"> </span><span class="nx">global</span><span class="w"> </span><span class="nx">stay_on_while_plugged_in</span><span class="w"> </span><span class="nx">3</span><span class="w">  
</span><span class="p">}</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">adb-stay-off</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="o">.</span><span class="nv">${Env:ProgramFiles(x86)}</span><span class="n">\Android\android-sdk\platform-tools\adb.exe</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">settings</span><span class="w"> </span><span class="nx">put</span><span class="w"> </span><span class="nx">global</span><span class="w"> </span><span class="nx">stay_on_while_plugged_in</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Let’s break that down</p>

<p><code class="language-plaintext highlighter-rouge">.</code> means that this is an executable</p>

<p><code class="language-plaintext highlighter-rouge">${Env:ProgramFiles(x86)}</code> is the environment variable that points to the <code class="language-plaintext highlighter-rouge">Program Files (x86)</code> folder</p>

<p><code class="language-plaintext highlighter-rouge">${Env:ProgramFiles(x86)}\Android\android-sdk\platform-tools\adb.exe</code> is the full path to the adb command</p>

<p><code class="language-plaintext highlighter-rouge">shell settings put global stay_on_while_plugged_in 3 </code> Shell accesses the OS, settings put means update a setting and stay_on_while_plugged_in 3 is the setting to enable the stay on setting.</p>

<p>The functions work even when I don’t have adb on the path. Now I can invoke <code class="language-plaintext highlighter-rouge">adb-stay-on</code> when I have connected my phone to my PC to use for debugging. And when I’m done, I can just <code class="language-plaintext highlighter-rouge">invoke adb-stay-off</code>.</p>

<p>This will not prevent the device from going to the lock screen. There are various ways of preventing that. I have a Samsung Galaxy and I have it set to stay unlocked when I’m home.</p>]]></content><author><name>anotherlab</name></author><category term="powershell" /><category term="abd" /><category term="power" /><summary type="html"><![CDATA[Usually when I’m writing .NET MAUI code for Android, I use an emulator to test the code. It’s fast and there are fewer things that can go wrong. And most of time it’s good enough. When you need to access something hardware related, you want real hardware. I’m working on stuff that uses BLE and you can’t really test with an emulator. You need the real deal. So I’ll use my phone. One annoyance of using a real device is that it will turn the screen off after X minutes of inactivity. Usually just before you want to test some code. There is a setting that you can change to override this. If you go to Developer Options, under settings, there should be a setting named “Stay awake”. You need to have developer mode enabled, but if you are writing Android apps you already know that. I’m lazy and I hate having to dig through options. This is something that you can do through the command line. You can enable the stay awake session with the following adb command: adb shell settings put global stay_on_while_plugged_in 3 And to turn it, do the following: adb shell settings put global stay_on_while_plugged_in 0 To get the current status, use this adb shell settings get global stay_on_while_plugged_in To make this even lazier easier for me, I added a pair of functions to my PowerShell profile. function adb-stay-on { .${Env:ProgramFiles(x86)}\Android\android-sdk\platform-tools\adb.exe shell settings put global stay_on_while_plugged_in 3 } function adb-stay-off { .${Env:ProgramFiles(x86)}\Android\android-sdk\platform-tools\adb.exe shell settings put global stay_on_while_plugged_in 0 } Let’s break that down . means that this is an executable ${Env:ProgramFiles(x86)} is the environment variable that points to the Program Files (x86) folder ${Env:ProgramFiles(x86)}\Android\android-sdk\platform-tools\adb.exe is the full path to the adb command shell settings put global stay_on_while_plugged_in 3 Shell accesses the OS, settings put means update a setting and stay_on_while_plugged_in 3 is the setting to enable the stay on setting. The functions work even when I don’t have adb on the path. Now I can invoke adb-stay-on when I have connected my phone to my PC to use for debugging. And when I’m done, I can just invoke adb-stay-off. This will not prevent the device from going to the lock screen. There are various ways of preventing that. I have a Samsung Galaxy and I have it set to stay unlocked when I’m home.]]></summary></entry><entry><title type="html">Breaking and then fixing my app’s CFBundleShortVersionString</title><link href="http://localhost:4000/2025/03/10/CFBundleShortVersionString/" rel="alternate" type="text/html" title="Breaking and then fixing my app’s CFBundleShortVersionString" /><published>2025-03-10T00:00:00+00:00</published><updated>2025-03-10T00:00:00+00:00</updated><id>http://localhost:4000/2025/03/10/CFBundleShortVersionString</id><content type="html" xml:base="http://localhost:4000/2025/03/10/CFBundleShortVersionString/"><![CDATA[<p><img src="/assets/images/steampunk-mobile-app-assembly-line.jpg" alt="Made to order" /></p>

<p>So I had this bug reported where the app was reporting the wrong version number. Only for iOS, it was correct on Android. It’s an app created with .NET MAUI and it gets built as part of a GitHub workflow when the main branch is updated. The MAUI code that shows the version number is the same for Android and iOS. That indicated the version information was not being set correctly.</p>

<p>We have two version numbers in the app. For iOS, they are named <a href="https://developer.apple.com/documentation/bundleresources/information-property-list/cfbundleversion">CFBundleVersion</a> and <a href="https://developer.apple.com/documentation/bundleresources/information-property-list/cfbundleshortversionstring">CFBundleShortVersionString</a>. CFBundleShortVersionString is supposed to be user-visible version of CFBundleVersion. If CFBundleVersion is set to “1.2.345”, then CFBundleShortVersionString could be set to “1.2 build 345”.</p>

<p><code class="language-plaintext highlighter-rouge">CFBundleVersion</code> is the value that identifies the version of the build. Becareful when you set this. It can go up, but it can’t go back down. The original developer didn’t understand how this worked and when they first submitted the app to the Apple app store, they thought it had to be an integer. Instead of setting the value to “1.2.3456”, they set it to something like “1023456”. It got out of sync with <code class="language-plaintext highlighter-rouge">CFBundleShortVersionString</code>.</p>

<p>This was back when it was a Xamarin.Forms app. In Xamarin.Forms, we set <code class="language-plaintext highlighter-rouge">CFBundleVersion</code> and <code class="language-plaintext highlighter-rouge">CFBundleShortVersionString</code> in the <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Introduction/Introduction.html">Info.plist</a> file. In .NET MAUI, you can set that in the .csproj project file. the Info.plist, or via command line parameters. I had placeholder values in the project file and used the command line parameters to set the version numbers as part of the build command.</p>

<p>I have a GitHub workflow set up for when the main branch is updated. It uses an open-source GutHub action named <a href="https://github.com/haya14busa/action-bumpr">action-bumpr</a>. This action-bumpr action can set all or part of semantic version number.</p>

<!--  -->
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">bump-version</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">${{ steps.clean_version.outputs.version }}</span>
      <span class="na">versioncode</span><span class="pi">:</span> <span class="s">${{ steps.clean_version.outputs.versioncode }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">haya14busa/action-bumpr@v1</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">bumpr</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github_token</span><span class="pi">:</span> <span class="s">${{ github.token }}</span>
          <span class="na">default_bump_level</span><span class="pi">:</span> <span class="s1">'</span><span class="s">patch'</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">clean version</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">clean_version</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">v=${{ steps.bumpr.outputs.next_version }}</span>
          <span class="s">v=${v:1}</span>
          <span class="s">echo "version=$v" &gt;&gt; $GITHUB_OUTPUT</span>
          <span class="s">count=$(git rev-list --count HEAD)</span>
          <span class="s">let "count += 2100000"</span>
          <span class="s">echo "versioncode=$count" &gt;&gt; $GITHUB_OUTPUT</span>
</code></pre></div></div>
<!--  -->

<p>The <code class="language-plaintext highlighter-rouge">version</code> variable ends up with “1.2.3456” and <code class="language-plaintext highlighter-rouge">versioncount</code> gets the build count with a “magic number” of 2100000 added to it. The versioncount variable is being set this way only because we had it wrong from day one and you can only go up in value.</p>

<p>The “jobs:” job is used by a job called “build-ios:”. After doing all of the setup stuff, it fires up the following command to build the app</p>

<!--  -->
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Publish iOS</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">dotnet publish -c Release -f:net9.0-ios /p:ArchiveOnBuild=true /p:RuntimeIdentifier=ios-arm64 /p:ApplicationDisplayVersion=${{ needs.bump-version.outputs.version }} /p:ApplicationVersion=${{ needs.bump-version.outputs.versioncode }}</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">MyApp</span>
</code></pre></div></div>
<!--  -->
<p>YAML’s formatting makes that hard to read in a blog post. If we just look at the version parameters:
<!--  --></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">/p:ApplicationDisplayVersion=${{ needs.bump-version.outputs.version }}</span>
<span class="s">/p:ApplicationVersion=${{ needs.bump-version.outputs.versioncode }}</span>
</code></pre></div></div>
<!--  -->

<p>The p:ApplicationDisplayVersion parameter maps to <code class="language-plaintext highlighter-rouge">CFBundleShortVersionString</code> and /p:ApplicationVersion maps to CFBundleVersion. This is were the version values are passed. When I did the build, <code class="language-plaintext highlighter-rouge">CFBundleShortVersionString</code> was not being set correctly. So I had decided to cheat and set it in Info.plist before calling the Publish iOS step.</p>

<!--  -->
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Update CFBundleShortVersionString</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">/usr/libexec/PlistBuddy ${{ github.workspace }}/MyStop/Platforms/iOS/Info.plist -c "set :CFBundleShortVersionString '${{ needs.bump-version.outputs.versioncode }}'";</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">MyStop/Platforms/iOS</span>
</code></pre></div></div>
<!--  -->

<p>PlistBuddy is a tool that is part of MacOS. It lets you edit .plist files from the command line. You can give the “-h” parameter to some terse help. I found a nice guide <a href="https://github.com/captam3rica/plistbuddy-guide">here</a>.</p>

<p>This was were I made the mistake. I was setting <code class="language-plaintext highlighter-rouge">CFBundleShortVersionString</code> to the version code and I should have used the version string. The root cause of the problem is that if you have <code class="language-plaintext highlighter-rouge">CFBundleShortVersionString</code> defined in Info.plist, that value take precedence over any value specified from the command line. It’s usually the other way around, the command line takes precedence.</p>

<p>I though the fix would be easy. Remove <code class="language-plaintext highlighter-rouge">CFBundleShortVersionString</code> from Info.plist and remove the Plistbuddy lines from the workflow. That did set the correct version number. It didn’t fix the problem with correct x.y.zzzz format version number being considered lower than XXXXXXXX by Apple. So time for a hack.</p>

<p>In the C# code that provides the version number in the App, the code will branch.  If the platform is Android, just return the version number. If it’s iOS, check for X.Y.Z format and if that matches return that. If it’s an integer value, we make some assumptions.  We take number and subtract the “magic number” that we had added to the git revision number that we had used in the <code class="language-plaintext highlighter-rouge">bump-version:</code> job.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">let "count += 2100000"</span>
</code></pre></div></div>
<p>To convert that hot mess of a int to a user-readable version number, you could implement something like this:</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">string</span> <span class="nf">GetVersionNumber</span><span class="p">(</span><span class="kt">string</span> <span class="n">someValue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">// Magic number and version prefix are hard coded</span>
	<span class="c1">// It is what it is</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">MagicNumber</span> <span class="p">=</span> <span class="m">2100000</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">string</span> <span class="n">prefix</span> <span class="p">=</span> <span class="s">"1.2"</span><span class="p">;</span>
	
	<span class="c1">// Sanity check on converting what we expect to get</span>
	<span class="c1">// to an int value</span>
	<span class="k">if</span> <span class="p">(</span><span class="kt">int</span><span class="p">.</span><span class="nf">TryParse</span><span class="p">(</span><span class="n">someValue</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> <span class="n">result</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">result</span> <span class="p">-=</span> <span class="n">MagicNumber</span><span class="p">;</span>

		<span class="c1">// Format and return to the call</span>
		<span class="k">return</span> <span class="s">$"</span><span class="p">{</span><span class="n">prefix</span><span class="p">}</span><span class="s">.</span><span class="p">{</span><span class="n">result</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">// If something wasn't correct, return something back</span>
	<span class="k">return</span> <span class="n">prefix</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>It’s a hack and it depends on the source code knowing what the X and Y are for the X.Y.ZZZZ parts of the version number. But it works.</p>]]></content><author><name>anotherlab</name></author><category term="versioning" /><category term="ios" /><category term="github" /><category term="yaml" /><category term="Info.plist" /><summary type="html"><![CDATA[So I had this bug reported where the app was reporting the wrong version number. Only for iOS, it was correct on Android. It’s an app created with .NET MAUI and it gets built as part of a GitHub workflow when the main branch is updated. The MAUI code that shows the version number is the same for Android and iOS. That indicated the version information was not being set correctly. We have two version numbers in the app. For iOS, they are named CFBundleVersion and CFBundleShortVersionString. CFBundleShortVersionString is supposed to be user-visible version of CFBundleVersion. If CFBundleVersion is set to “1.2.345”, then CFBundleShortVersionString could be set to “1.2 build 345”. CFBundleVersion is the value that identifies the version of the build. Becareful when you set this. It can go up, but it can’t go back down. The original developer didn’t understand how this worked and when they first submitted the app to the Apple app store, they thought it had to be an integer. Instead of setting the value to “1.2.3456”, they set it to something like “1023456”. It got out of sync with CFBundleShortVersionString. This was back when it was a Xamarin.Forms app. In Xamarin.Forms, we set CFBundleVersion and CFBundleShortVersionString in the Info.plist file. In .NET MAUI, you can set that in the .csproj project file. the Info.plist, or via command line parameters. I had placeholder values in the project file and used the command line parameters to set the version numbers as part of the build command. I have a GitHub workflow set up for when the main branch is updated. It uses an open-source GutHub action named action-bumpr. This action-bumpr action can set all or part of semantic version number. jobs: bump-version: runs-on: ubuntu-latest outputs: version: ${{ steps.clean_version.outputs.version }} versioncode: ${{ steps.clean_version.outputs.versioncode }} steps: - uses: actions/checkout@v2 - uses: haya14busa/action-bumpr@v1 id: bumpr with: github_token: ${{ github.token }} default_bump_level: 'patch' - name: clean version id: clean_version run: | v=${{ steps.bumpr.outputs.next_version }} v=${v:1} echo "version=$v" &gt;&gt; $GITHUB_OUTPUT count=$(git rev-list --count HEAD) let "count += 2100000" echo "versioncode=$count" &gt;&gt; $GITHUB_OUTPUT The version variable ends up with “1.2.3456” and versioncount gets the build count with a “magic number” of 2100000 added to it. The versioncount variable is being set this way only because we had it wrong from day one and you can only go up in value. The “jobs:” job is used by a job called “build-ios:”. After doing all of the setup stuff, it fires up the following command to build the app - name: Publish iOS run: dotnet publish -c Release -f:net9.0-ios /p:ArchiveOnBuild=true /p:RuntimeIdentifier=ios-arm64 /p:ApplicationDisplayVersion=${{ needs.bump-version.outputs.version }} /p:ApplicationVersion=${{ needs.bump-version.outputs.versioncode }} working-directory: MyApp YAML’s formatting makes that hard to read in a blog post. If we just look at the version parameters: /p:ApplicationDisplayVersion=${{ needs.bump-version.outputs.version }} /p:ApplicationVersion=${{ needs.bump-version.outputs.versioncode }} The p:ApplicationDisplayVersion parameter maps to CFBundleShortVersionString and /p:ApplicationVersion maps to CFBundleVersion. This is were the version values are passed. When I did the build, CFBundleShortVersionString was not being set correctly. So I had decided to cheat and set it in Info.plist before calling the Publish iOS step. - name: Update CFBundleShortVersionString run: /usr/libexec/PlistBuddy ${{ github.workspace }}/MyStop/Platforms/iOS/Info.plist -c "set :CFBundleShortVersionString '${{ needs.bump-version.outputs.versioncode }}'"; working-directory: MyStop/Platforms/iOS PlistBuddy is a tool that is part of MacOS. It lets you edit .plist files from the command line. You can give the “-h” parameter to some terse help. I found a nice guide here. This was were I made the mistake. I was setting CFBundleShortVersionString to the version code and I should have used the version string. The root cause of the problem is that if you have CFBundleShortVersionString defined in Info.plist, that value take precedence over any value specified from the command line. It’s usually the other way around, the command line takes precedence. I though the fix would be easy. Remove CFBundleShortVersionString from Info.plist and remove the Plistbuddy lines from the workflow. That did set the correct version number. It didn’t fix the problem with correct x.y.zzzz format version number being considered lower than XXXXXXXX by Apple. So time for a hack. In the C# code that provides the version number in the App, the code will branch. If the platform is Android, just return the version number. If it’s iOS, check for X.Y.Z format and if that matches return that. If it’s an integer value, we make some assumptions. We take number and subtract the “magic number” that we had added to the git revision number that we had used in the bump-version: job. let "count += 2100000" To convert that hot mess of a int to a user-readable version number, you could implement something like this: string GetVersionNumber(string someValue) { // Magic number and version prefix are hard coded // It is what it is const int MagicNumber = 2100000; const string prefix = "1.2"; // Sanity check on converting what we expect to get // to an int value if (int.TryParse(someValue, out int result)) { result -= MagicNumber; // Format and return to the call return $"{prefix}.{result}"; } // If something wasn't correct, return something back return prefix; } It’s a hack and it depends on the source code knowing what the X and Y are for the X.Y.ZZZZ parts of the version number. But it works.]]></summary></entry><entry><title type="html">Poka-yoke</title><link href="http://localhost:4000/2025/03/05/poka-yoke/" rel="alternate" type="text/html" title="Poka-yoke" /><published>2025-03-05T00:00:00+00:00</published><updated>2025-03-05T00:00:00+00:00</updated><id>http://localhost:4000/2025/03/05/poka-yoke</id><content type="html" xml:base="http://localhost:4000/2025/03/05/poka-yoke/"><![CDATA[<p><img src="/assets/images/robots-poka-yoke.jpg" alt="Not good" /></p>

<p>So I used poka-yoke (ポカヨケ) in a conversation yesterday. I am working on an update to an app that uses a web service. Under an extreme edge condition, the app would make an API call with a missing parameter that was required. This would error out on the service side and we caught it with the logs.</p>

<p>The simple fix was to change the API call so it would check for missing data coming in and just return without doing anything. I went full poka-yoke and also changed the app so it wouldn’t make the call until it had the required information. Easy enough fixes. When I was chatting with my boss about the fixes, I dropped the term poka-yoke into the chat.</p>

<p>Years ago, I worked on statistical process control (SPC) software for companies that made packaging material. The term poka-yoke was the buzzword of the day and it stuck in my brain. It’s a Japanese term to describe the methods used to prevent errors. If you can prevent your assembly line from making an error, your quality goes up.</p>

<p>To implement poka-yoke, at each manufacturing stage, there is something in place that prevents a faulty output from going on to the next step. A part that is out of tolerance could be automatically redirected to a rejected parts bin. Or a part can’t be welded if it’s not correctly aligned. By doing these checks inline, problems can be addressed earlier in the process. This saves production time and production materials.</p>

<p>An example would be a machine that cuts corugated cardboard sheets to make boxes. If the cardboard is not lined up correctly, you get box that doesn’t fold up correctly. We used an optical sensor to measure the position of the sheets as they went through the cutter to make sure they lined up correctly and then on the side to make sure that the cuts were in the right place and of the correct dimensions.</p>

<p>Through software, we can check those sheets faster than the operator. If something was out of alignment, we could stop the machine before too many sheets were ruined. We helped our clients reduce the amount of downtime and saved them a lot of money.</p>

<p>You have something in your kitchen that is an example of poke-yoke. Your microwave wont turn on unless the door is closed. That seems fairly obvious, but it’s a clear example of how poke-yoke can be implemented.</p>

<p>To apply the principles of poka-yoke to software, one goal would be to prevent an error from propagating through multiple services. We have that old saying. “Garbage in, garbage out”. If you apply poka-yoke to that, it becomes “Garbage in, garbage rejected”. My change to the app to not allow an API call with invalid data is another example of poka-yoke.</p>

<p>Poka-yoke was developed by an industrial engineer named <a href="https://en.wikipedia.org/wiki/Shigeo_Shingo">Shigeo Shingo</a> for the <a href="https://en.wikipedia.org/wiki/Toyota_Production_System">Toyota Production System</a> (TPS) back in the 1960s. If you ever heard the term “just-in-time” manufacturing, it came from TPS. A translation of poka-yoke means “error-proofing”, from the words “poka” meaning mistakes and “yokeru” meaning to avoid. Which is better than the first term that Shingo used, baka-yoke. That translates to “idiot-proofing”, which was less than popular with the machine operators.</p>]]></content><author><name>anotherlab</name></author><category term="quality code" /><category term="jargon" /><summary type="html"><![CDATA[So I used poka-yoke (ポカヨケ) in a conversation yesterday. I am working on an update to an app that uses a web service. Under an extreme edge condition, the app would make an API call with a missing parameter that was required. This would error out on the service side and we caught it with the logs. The simple fix was to change the API call so it would check for missing data coming in and just return without doing anything. I went full poka-yoke and also changed the app so it wouldn’t make the call until it had the required information. Easy enough fixes. When I was chatting with my boss about the fixes, I dropped the term poka-yoke into the chat. Years ago, I worked on statistical process control (SPC) software for companies that made packaging material. The term poka-yoke was the buzzword of the day and it stuck in my brain. It’s a Japanese term to describe the methods used to prevent errors. If you can prevent your assembly line from making an error, your quality goes up. To implement poka-yoke, at each manufacturing stage, there is something in place that prevents a faulty output from going on to the next step. A part that is out of tolerance could be automatically redirected to a rejected parts bin. Or a part can’t be welded if it’s not correctly aligned. By doing these checks inline, problems can be addressed earlier in the process. This saves production time and production materials. An example would be a machine that cuts corugated cardboard sheets to make boxes. If the cardboard is not lined up correctly, you get box that doesn’t fold up correctly. We used an optical sensor to measure the position of the sheets as they went through the cutter to make sure they lined up correctly and then on the side to make sure that the cuts were in the right place and of the correct dimensions. Through software, we can check those sheets faster than the operator. If something was out of alignment, we could stop the machine before too many sheets were ruined. We helped our clients reduce the amount of downtime and saved them a lot of money. You have something in your kitchen that is an example of poke-yoke. Your microwave wont turn on unless the door is closed. That seems fairly obvious, but it’s a clear example of how poke-yoke can be implemented. To apply the principles of poka-yoke to software, one goal would be to prevent an error from propagating through multiple services. We have that old saying. “Garbage in, garbage out”. If you apply poka-yoke to that, it becomes “Garbage in, garbage rejected”. My change to the app to not allow an API call with invalid data is another example of poka-yoke. Poka-yoke was developed by an industrial engineer named Shigeo Shingo for the Toyota Production System (TPS) back in the 1960s. If you ever heard the term “just-in-time” manufacturing, it came from TPS. A translation of poka-yoke means “error-proofing”, from the words “poka” meaning mistakes and “yokeru” meaning to avoid. Which is better than the first term that Shingo used, baka-yoke. That translates to “idiot-proofing”, which was less than popular with the machine operators.]]></summary></entry><entry><title type="html">Refresh of this blog</title><link href="http://localhost:4000/2025/03/04/blog-refresh/" rel="alternate" type="text/html" title="Refresh of this blog" /><published>2025-03-04T00:00:00+00:00</published><updated>2025-03-04T00:00:00+00:00</updated><id>http://localhost:4000/2025/03/04/blog-refresh</id><content type="html" xml:base="http://localhost:4000/2025/03/04/blog-refresh/"><![CDATA[<p><img src="/assets/images/pc_on_fire.jpg" alt="Not good" /></p>

<p>The blog has been updated. Not just posts, all of the stuff that generates it. This wasn’t planned…</p>

<p>About two weeks ago, the boot drive of my PC failed. The drive was a Samsung 980 Pro 2TB. I had two of them, one for the OS, the other for data. Went to my PC on a normal Sunday morning only to see the BIOS configuration screen. After a few failed reboots, I came to the conclusion that something was seriously not good with by boot drive.</p>

<p><img src="/assets/images/uefi-bios-11.gif" alt="Rut ro" />
<em><small>Not my motherboard, but close enough</small></em></p>

<p>What I didn’t know was that this drive was shipped with a <a href="https://www.tomshardware.com/news/samsung-980-pro-ssd-failures-firmware-update">notorious firmware bug</a>. Eventually it would permanently lock itself into readonly mode.</p>

<p>Most of my data is backed up on regular basis. I have a <a href="https://www.qnap.com/en-as/product/ts-464">QNAP server</a> with about 7 TB of RAID storage. Stuff that is important to me is backed up there. I have a healthy degree of paranoia about disk backups. I assume that it will all fail. I backup up documents to external USB drives and store them at my daughter’s house. I count on those drives failing after a few years and will rotate them out.</p>

<p>I figure we’ll have USB around for a while longer. I use to burn documents to CD and the DVD. I don’t have any drives with spinning parts in this computer. USB is enough.</p>

<p>I was a bit sloppy with backing up some of the stuff, so I had some code on the boot drive that I didn’t want to lose. I was able to make a Windows 11 boot USB stick and with that stick, I could open a CMD shell and read the data from the boot drive.  I copied to data drive and to an external drive.</p>

<p>I made a few attempts to reinstall Windows, but that drive was locked into readonly mode. I ordered a new drive from a local BestBuy and picked it up.  All they had were Samsung 990 Pro drives in the 2 TB size. So that’s what I bought. I like the M.2 NVMe drives. They are fast and they just install on the motherboard. No power or data cables. When I assembled this <a href="https://pcpartpicker.com/list/BwHP6r">PC</a> 3 years ago, I did it without any SATA drives.</p>

<p>Now it was time to get to work. I have a <a href="https://www.msi.com/Motherboard/MPG-Z690-EDGE-WIFI-DDR4">MSI Z690 Edge Wifi DD4 motherboard</a>. It’s nice, I like it. It has four M.2 slots. One of them is directly controlled by the CPU, the other 3 are controlled by the Z690 chipset. The one controlled by the CPU is where I have the boot drive. It’s located between the CPU and the first PCIe slot. All of the M.2 slots have heatsinks on them. Which have to be unscrewed to get at the slots</p>

<p>I used a Fractal Desigm Torrent case for this PC. It’s fan cooled and very quiet. I have a massive Noctua CPU cooler. It partially covers the M.2 slot and I had to angle a screw driver in to get the heatsink off and swap the old drive with the new one. I had also had to remove the GPU to get at the M.2 slot. It’s always fiddly to swap stuff on the motherboard, but it wasn’t too bad.</p>

<p>I booted from the Win11 stick and tried to install Windows. Here is where I shot myself in the foot. Windows numbers the drives, starting from 0. The boot drive was 0, the data was 1. For some reason, the data drive was now 0 and the new one was 1. I just assumed that because I was using the same slot for the new drive, the numbering would stay the same.I ended up deleting the partition on the good drive so the Win11 installer could start fresh.</p>

<p>It rebooted and kept coming back to the installer on the USB stick. After a few attempts, I pulled the data drive out and with just one drive, Windows setup was able to install Windows. After Windows came up and updated itself, I powered down and installed the data drive. It came up and of course my data was gone. It was backed up, but I had some images and code that were only the data drive. I ended up buying <a href="https://www.anyrecover.com/">an app</a> that claimed to be able to recover data from a deleted partition.</p>

<p>AnyRecover lived up to it’s claim. It wasn’t quick, but I recoved what I needed to a folder on the new boot drive. I then formatted the data drive and moved the data back. That’s when a friend told me that these 980 Pro drives had a firmware version that would eventually lock the drive into readonly. I bought the data drive a month after building the PC, the odds were high that it had the same firmware. Samssung has a handy <a href="https://semiconductor.samsung.com/consumer-storage/magician/">Magician</a> app. It can show the firmware and other settings and it can update the firmware.</p>

<p>So I downloaded and installed the Magician app and then installed the broken drive to see what the Magician would say. It showed that the new 990 Pro had the current firmware, but both 980 Pro’s were on the bad firmware. It was able to update the firmware for the data drive, but failed on the old boot drive. It did allow me to access the serial number of the drive.</p>

<p><img src="/assets/images/samsung-magician.png" alt="Samsung Magician" />
<em><small>Screenshot of the Samsung Magician</small></em></p>

<p>I went to the Samsung Support site and filed a warranty claim. They took the serial number and immediately gave me a RMA number and a label to print. I sent the failed 980 Pro in. A few days later, I received a new 990 Pro drive back. Now I had three M.2 drives of 2 TB capacity each, which more than I needed. I didn’t realize until I wrote this blog post that the QNAP box has two M.2 slots. I thought my PC was the only thing I had that could use the drive.</p>

<p>So I added it as a new drive and formatted as a <a href="https://learn.microsoft.com/en-us/windows/dev-drive/">Windows Dev Drive</a>. Dev Drives use the <a href="https://learn.microsoft.com/en-us/windows-server/storage/refs/refs-overview">ReFS</a> file system instead of NTFS and they are treated as a “trusted drive” by the OS. The usual antivirus and other security policies are not applied to Dev Drives. So that’s where all of my source code lives now. It’s supposed to be faster, but it’s hard to to tell.</p>

<p>Now that the PC was running again and my data was safe, I could start the long process of installing and configuring the apps that I use. That will be another blog post. There was a lot to install and I’m almost there. Some configuration was required to the the blog stuff working again and this post is more or less a validation check for that.</p>]]></content><author><name>anotherlab</name></author><category term="Jekyll Blog Ubuntu" /><category term="Samsung M.2" /><summary type="html"><![CDATA[The blog has been updated. Not just posts, all of the stuff that generates it. This wasn’t planned… About two weeks ago, the boot drive of my PC failed. The drive was a Samsung 980 Pro 2TB. I had two of them, one for the OS, the other for data. Went to my PC on a normal Sunday morning only to see the BIOS configuration screen. After a few failed reboots, I came to the conclusion that something was seriously not good with by boot drive. Not my motherboard, but close enough What I didn’t know was that this drive was shipped with a notorious firmware bug. Eventually it would permanently lock itself into readonly mode. Most of my data is backed up on regular basis. I have a QNAP server with about 7 TB of RAID storage. Stuff that is important to me is backed up there. I have a healthy degree of paranoia about disk backups. I assume that it will all fail. I backup up documents to external USB drives and store them at my daughter’s house. I count on those drives failing after a few years and will rotate them out. I figure we’ll have USB around for a while longer. I use to burn documents to CD and the DVD. I don’t have any drives with spinning parts in this computer. USB is enough. I was a bit sloppy with backing up some of the stuff, so I had some code on the boot drive that I didn’t want to lose. I was able to make a Windows 11 boot USB stick and with that stick, I could open a CMD shell and read the data from the boot drive. I copied to data drive and to an external drive. I made a few attempts to reinstall Windows, but that drive was locked into readonly mode. I ordered a new drive from a local BestBuy and picked it up. All they had were Samsung 990 Pro drives in the 2 TB size. So that’s what I bought. I like the M.2 NVMe drives. They are fast and they just install on the motherboard. No power or data cables. When I assembled this PC 3 years ago, I did it without any SATA drives. Now it was time to get to work. I have a MSI Z690 Edge Wifi DD4 motherboard. It’s nice, I like it. It has four M.2 slots. One of them is directly controlled by the CPU, the other 3 are controlled by the Z690 chipset. The one controlled by the CPU is where I have the boot drive. It’s located between the CPU and the first PCIe slot. All of the M.2 slots have heatsinks on them. Which have to be unscrewed to get at the slots I used a Fractal Desigm Torrent case for this PC. It’s fan cooled and very quiet. I have a massive Noctua CPU cooler. It partially covers the M.2 slot and I had to angle a screw driver in to get the heatsink off and swap the old drive with the new one. I had also had to remove the GPU to get at the M.2 slot. It’s always fiddly to swap stuff on the motherboard, but it wasn’t too bad. I booted from the Win11 stick and tried to install Windows. Here is where I shot myself in the foot. Windows numbers the drives, starting from 0. The boot drive was 0, the data was 1. For some reason, the data drive was now 0 and the new one was 1. I just assumed that because I was using the same slot for the new drive, the numbering would stay the same.I ended up deleting the partition on the good drive so the Win11 installer could start fresh. It rebooted and kept coming back to the installer on the USB stick. After a few attempts, I pulled the data drive out and with just one drive, Windows setup was able to install Windows. After Windows came up and updated itself, I powered down and installed the data drive. It came up and of course my data was gone. It was backed up, but I had some images and code that were only the data drive. I ended up buying an app that claimed to be able to recover data from a deleted partition. AnyRecover lived up to it’s claim. It wasn’t quick, but I recoved what I needed to a folder on the new boot drive. I then formatted the data drive and moved the data back. That’s when a friend told me that these 980 Pro drives had a firmware version that would eventually lock the drive into readonly. I bought the data drive a month after building the PC, the odds were high that it had the same firmware. Samssung has a handy Magician app. It can show the firmware and other settings and it can update the firmware. So I downloaded and installed the Magician app and then installed the broken drive to see what the Magician would say. It showed that the new 990 Pro had the current firmware, but both 980 Pro’s were on the bad firmware. It was able to update the firmware for the data drive, but failed on the old boot drive. It did allow me to access the serial number of the drive. Screenshot of the Samsung Magician I went to the Samsung Support site and filed a warranty claim. They took the serial number and immediately gave me a RMA number and a label to print. I sent the failed 980 Pro in. A few days later, I received a new 990 Pro drive back. Now I had three M.2 drives of 2 TB capacity each, which more than I needed. I didn’t realize until I wrote this blog post that the QNAP box has two M.2 slots. I thought my PC was the only thing I had that could use the drive. So I added it as a new drive and formatted as a Windows Dev Drive. Dev Drives use the ReFS file system instead of NTFS and they are treated as a “trusted drive” by the OS. The usual antivirus and other security policies are not applied to Dev Drives. So that’s where all of my source code lives now. It’s supposed to be faster, but it’s hard to to tell. Now that the PC was running again and my data was safe, I could start the long process of installing and configuring the apps that I use. That will be another blog post. There was a lot to install and I’m almost there. Some configuration was required to the the blog stuff working again and this post is more or less a validation check for that.]]></summary></entry><entry><title type="html">You can find me on Bluesky</title><link href="http://localhost:4000/2025/02/06/bluesky/" rel="alternate" type="text/html" title="You can find me on Bluesky" /><published>2025-02-06T00:00:00+00:00</published><updated>2025-02-06T00:00:00+00:00</updated><id>http://localhost:4000/2025/02/06/bluesky</id><content type="html" xml:base="http://localhost:4000/2025/02/06/bluesky/"><![CDATA[<p><img loading="lazy" class="aligncenter size-medium" src="https://photos.smugmug.com/Blog/n-zwT5d/2025/i-8TCX2Qm/0/NQn4T72595x5vLgj8nvz3LtjNVjSLf5bqffPHMrcR/M/bluesky-M.jpg" /></p>

<p>I’ve been on <a href="https://bsky.app/">Bluesky</a> for a while now. I still have my account on the dead bird site, but I haven’t posted to it in ages. Not since Musk decided to burn billions of dollars. I never announced that I had quit that site, I just stopped using it. There are few technical sites that are there, so I kept my account active so that I could view their posts.</p>

<p>I try to use the same handle on social media sites and Bluesky is no exception.  I’m using the default domain, so you can find me at <a href="https://bsky.app/profile/anotherlab.bsky.social">anotherlab.bsky.social</a>.</p>

<p>By the way, if you want to read a great book on how to wreck a company, I highly reccomend <a href="https://www.penguinrandomhouse.com/books/737290/character-limit-by-kate-conger-and-ryan-mac/">“Character Limit”</a>. It’s written by <a href="https://bsky.app/profile/did:plc:5siz7r23475fek2mj6p5zhzw">Kate Conger</a> and <a href="https://bsky.app/profile/rmac.bsky.social">Ryan Mac</a>. It’s an inside look of when Musk acquired Twitter.</p>]]></content><author><name>anotherlab</name></author><category term="Social Media" /><category term="Bluesky" /><summary type="html"><![CDATA[I’ve been on Bluesky for a while now. I still have my account on the dead bird site, but I haven’t posted to it in ages. Not since Musk decided to burn billions of dollars. I never announced that I had quit that site, I just stopped using it. There are few technical sites that are there, so I kept my account active so that I could view their posts. I try to use the same handle on social media sites and Bluesky is no exception. I’m using the default domain, so you can find me at anotherlab.bsky.social. By the way, if you want to read a great book on how to wreck a company, I highly reccomend “Character Limit”. It’s written by Kate Conger and Ryan Mac. It’s an inside look of when Musk acquired Twitter.]]></summary></entry><entry><title type="html">Apple needs to sort out their API</title><link href="http://localhost:4000/2024/08/27/apples-api-needs-to-be-sorted/" rel="alternate" type="text/html" title="Apple needs to sort out their API" /><published>2024-08-27T00:00:00+00:00</published><updated>2024-08-27T00:00:00+00:00</updated><id>http://localhost:4000/2024/08/27/apples-api-needs-to-be-sorted</id><content type="html" xml:base="http://localhost:4000/2024/08/27/apples-api-needs-to-be-sorted/"><![CDATA[<p style="text-align: center;"><img src="/assets/steam-punk-scientist.jpg" alt="Who broke the API?" /></p>

<p>I have some code that uses Apple’s <a href="https://developer.apple.com/documentation/appstoreconnectapi">AppConnect API</a> to query App store related things. I wrote a C# script that I run from <a href="https://www.linqpad.net/">LINQPad</a> that gives me a weekly status update for the account. We link provisioned devices to the registered users in the account by their name. By querying the device list and referencing it wiht the user list, I quickly identify when someome provisions a new device without identifying who has that device.</p>

<p>Why do I need to do that? Apple only allows 100 devices per type to be provisioned as a developer device. 100 iPhones, 100 iPads, etc.  You need to provision a device with Apple to run development code on it. When you a have bigger team, 100 is a hard limit to manage.  We only allow a developer to provision one device type. Matching the name to the user is how we manage it.</p>

<p>I ran the script this morning and it reported devices that were fine as being invalid. Like my boss’s iPad. I knew his user account was still valid, so something broke in my script. I ran the script again and his device was fine. Ran it again and it was a problem again. That’s weird.</p>

<p>I tore apart my script and the code that retrieves the user list uses the List Users endpoint, documented <a href="https://developer.apple.com/documentation/appstoreconnectapi/list_users">here</a>.</p>

<p>I have the following code to call the API and get the set of users</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">GetUsers</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">string</span> <span class="n">nextUrl</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>

  <span class="n">client</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Authorization</span> <span class="p">=</span>
    <span class="k">new</span> <span class="nf">AuthenticationHeaderValue</span><span class="p">(</span><span class="s">"Bearer"</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>

  <span class="kt">var</span> <span class="n">url</span> <span class="p">=</span> <span class="n">nextUrl</span> <span class="p">??</span> <span class="s">$"https://api.appstoreconnect.apple.com/v1/users?limit=</span><span class="p">{</span><span class="n">count</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
    
  <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">==</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">InternalServerError</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span><span class="p">.</span><span class="nf">Dump</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="kt">var</span> <span class="n">users</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">users</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Let’s take a closer look at the following line</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">url</span> <span class="p">=</span> <span class="n">nextUrl</span> <span class="p">??</span> <span class="s">$"https://api.appstoreconnect.apple.com/v1/users?limit=</span><span class="p">{</span><span class="n">count</span><span class="p">}</span><span class="s">"</span><span class="p">;</span></code></pre></figure>

<p>The users api call will return a set of records, based on the value of of the limit parameter. The maximum number of rows that can be returned is 200. I set the value of count to 100. We have 160 users. The first we call it, we pass in null for nextUrl.</p>

<p>In the JSON data that is returned, we have an object containing the set of users and a Links.Next property. If there are more users, Links.Next will be set to a URI that will return the next set of users. So our call to get all of the users would like this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="code"><pre><span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="nf">GetUserList</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">List</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">users</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;();</span>
  
  <span class="kt">int</span> <span class="n">RequestSize</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>

  <span class="kt">var</span> <span class="n">jsonString</span> <span class="p">=</span> <span class="nf">GetUsers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">RequestSize</span><span class="p">,</span> <span class="k">null</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">jsonString</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="n">users</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">var</span> <span class="n">appConnectUsers</span> <span class="p">=</span> <span class="n">AppConnectUsers</span><span class="p">.</span><span class="nf">FromJson</span><span class="p">(</span><span class="n">jsonString</span><span class="p">);</span>
  
  <span class="n">users</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">appConnectUsers</span><span class="p">.</span><span class="n">Data</span>
    <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Attributes</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">User</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">UserName</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Username</span><span class="p">,</span> <span class="n">LastName</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">LastName</span><span class="p">,</span> <span class="n">FirstName</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span> <span class="n">Roles</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Roles</span><span class="p">.</span><span class="nf">ToList</span><span class="p">()</span> 
    <span class="p">}));</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">appConnectUsers</span><span class="p">.</span><span class="n">Links</span><span class="p">.</span><span class="n">Next</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">jsonString</span> <span class="p">=</span> <span class="nf">GetUsers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">RequestSize</span><span class="p">,</span> <span class="n">appConnectUsers</span><span class="p">.</span><span class="n">Links</span><span class="p">.</span><span class="n">Next</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()).</span><span class="n">Result</span><span class="p">;</span>
    <span class="n">appConnectUsers</span> <span class="p">=</span> <span class="n">AppConnectUsers</span><span class="p">.</span><span class="nf">FromJson</span><span class="p">(</span><span class="n">jsonString</span><span class="p">);</span>

    <span class="n">users</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">appConnectUsers</span><span class="p">.</span><span class="n">Data</span>
      <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Attributes</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">User</span><span class="p">()</span> <span class="p">{</span> 
        <span class="n">UserName</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Username</span><span class="p">,</span> <span class="n">LastName</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">LastName</span><span class="p">,</span> <span class="n">FirstName</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span> <span class="n">Roles</span> <span class="p">=</span> <span class="n">s</span><span class="p">.</span><span class="n">Roles</span><span class="p">.</span><span class="nf">ToList</span><span class="p">()</span> 
      <span class="p">}));</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">users</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The Links.Next property has the value that we use for nextUrl. We use a while loop to keep requesting more data until Links.Next comes back as null. While I could have set the request size to 200 and retrieved all of the users in one shot, at some point we’ll have more than 200 and it was better to work out the “paging” now.</p>

<p>When I called GetUserList and dumped out the users returned, I saw a problem. I would always get 160 users. Each and every time.  But there would be duplicates for some users and others would be missing. And it was non-deterministic. Each time I ran it, I would get different results.</p>

<p>One of the query parameters to the list users command is sort. My boss suggested that they probably added sorting and give that a shot. He was wrong about sort being added to the API, but if I sorted by username, I would get all 160 users.  All I needed to do was to change the URL to this:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">url</span> <span class="p">=</span> <span class="n">nextUrl</span> <span class="p">??</span> <span class="s">$"https://api.appstoreconnect.apple.com/v1/users?limit=</span><span class="p">{</span><span class="n">count</span><span class="p">}</span><span class="s">&amp;sort=username"</span><span class="p">;</span></code></pre></figure>

<p>And that solved the problem. All of users came back as expected. No duplicates and none were missing. Apple’s documentation for their API has a show API changes widget. The sort command was not new and it was not listed as a requirement. This was just one of those times when you have to keeping poking the code with a sharp stick to see what falls out.</p>]]></content><author><name>anotherlab</name></author><category term="Apple" /><category term="Apple" /><category term="C#" /><summary type="html"><![CDATA[I have some code that uses Apple’s AppConnect API to query App store related things. I wrote a C# script that I run from LINQPad that gives me a weekly status update for the account. We link provisioned devices to the registered users in the account by their name. By querying the device list and referencing it wiht the user list, I quickly identify when someome provisions a new device without identifying who has that device. Why do I need to do that? Apple only allows 100 devices per type to be provisioned as a developer device. 100 iPhones, 100 iPads, etc. You need to provision a device with Apple to run development code on it. When you a have bigger team, 100 is a hard limit to manage. We only allow a developer to provision one device type. Matching the name to the user is how we manage it. I ran the script this morning and it reported devices that were fine as being invalid. Like my boss’s iPad. I knew his user account was still valid, so something broke in my script. I ran the script again and his device was fine. Ran it again and it was a problem again. That’s weird. I tore apart my script and the code that retrieves the user list uses the List Users endpoint, documented here. I have the following code to call the API and get the set of users 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public async Task&lt;string&gt; GetUsers(string token, int count, string nextUrl) { var client = new HttpClient(); client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token); var url = nextUrl ?? $"https://api.appstoreconnect.apple.com/v1/users?limit={count}"; var result = await client.GetAsync(url); if (result.StatusCode == System.Net.HttpStatusCode.InternalServerError) { result.Dump(); return null; } else { var users = result.Content.ReadAsStringAsync(); return users.Result; } } Let’s take a closer look at the following line var url = nextUrl ?? $"https://api.appstoreconnect.apple.com/v1/users?limit={count}"; The users api call will return a set of records, based on the value of of the limit parameter. The maximum number of rows that can be returned is 200. I set the value of count to 100. We have 160 users. The first we call it, we pass in null for nextUrl. In the JSON data that is returned, we have an object containing the set of users and a Links.Next property. If there are more users, Links.Next will be set to a URI that will return the next set of users. So our call to get all of the users would like this: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 private List&lt;User&gt; GetUserList(string token) { List&lt;User&gt; users = new List&lt;User&gt;(); int RequestSize = 100; var jsonString = GetUsers(token, RequestSize, null).Result; if (jsonString == null) { return users; } var appConnectUsers = AppConnectUsers.FromJson(jsonString); users.AddRange(appConnectUsers.Data .Select(s =&gt; s.Attributes) .Select(s =&gt; new User() { UserName = s.Username, LastName = s.LastName, FirstName = s.FirstName, Roles = s.Roles.ToList() })); while (appConnectUsers.Links.Next != null) { jsonString = GetUsers(token, RequestSize, appConnectUsers.Links.Next.ToString()).Result; appConnectUsers = AppConnectUsers.FromJson(jsonString); users.AddRange(appConnectUsers.Data .Select(s =&gt; s.Attributes) .Select(s =&gt; new User() { UserName = s.Username, LastName = s.LastName, FirstName = s.FirstName, Roles = s.Roles.ToList() })); } return users; } The Links.Next property has the value that we use for nextUrl. We use a while loop to keep requesting more data until Links.Next comes back as null. While I could have set the request size to 200 and retrieved all of the users in one shot, at some point we’ll have more than 200 and it was better to work out the “paging” now. When I called GetUserList and dumped out the users returned, I saw a problem. I would always get 160 users. Each and every time. But there would be duplicates for some users and others would be missing. And it was non-deterministic. Each time I ran it, I would get different results. One of the query parameters to the list users command is sort. My boss suggested that they probably added sorting and give that a shot. He was wrong about sort being added to the API, but if I sorted by username, I would get all 160 users. All I needed to do was to change the URL to this: var url = nextUrl ?? $"https://api.appstoreconnect.apple.com/v1/users?limit={count}&amp;sort=username"; And that solved the problem. All of users came back as expected. No duplicates and none were missing. Apple’s documentation for their API has a show API changes widget. The sort command was not new and it was not listed as a requirement. This was just one of those times when you have to keeping poking the code with a sharp stick to see what falls out.]]></summary></entry></feed>