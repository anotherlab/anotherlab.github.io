<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>How to access Apple’s App Connect API from C#, Python, and Go. - Part 2 - Chris Miller’s 4th Blog</title>
<meta name="description" content="">


  <meta name="author" content="Chris Miller">
  
  <meta property="article:author" content="Chris Miller">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Chris Miller's 4th Blog">
<meta property="og:title" content="How to access Apple’s App Connect API from C#, Python, and Go. - Part 2">
<meta property="og:url" content="/2021/07/12/how-to-access-apples-app-connect-api-from-c-python-and-go-part-2/">


  <meta property="og:description" content="">





  <meta name="twitter:site" content="@anotherlab">
  <meta name="twitter:title" content="How to access Apple’s App Connect API from C#, Python, and Go. - Part 2">
  <meta name="twitter:description" content="">
  <meta name="twitter:url" content="/2021/07/12/how-to-access-apples-app-connect-api-from-c-python-and-go-part-2/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2021-07-12T09:02:52-04:00">






<link rel="canonical" href="/2021/07/12/how-to-access-apples-app-connect-api-from-c-python-and-go-part-2/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Chris Miller",
      "url": "/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Chris Miller's 4th Blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Chris Miller's 4th Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/posts/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="/">
        <img src="https://assets.about.me/background/users/t/h/i/thisischrismiller_1488935098_536.jpg" alt="Chris Miller" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="/" itemprop="url">Chris Miller</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>I am a Microsoft MVP, a Xamarin Certified Mobile Developer for iOS and Android, and the leader of the Tech Valley .NET User Group.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Albany, NY</span>
        </li>
      

      
        
          
            <li><a href="https://" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
            <li><a href="https://twitter.com/anotherlab" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/anotherlab" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/christophermiller/" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://instagram.com/anotherlab" rel="nofollow noopener noreferrer me"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i><span class="label">Instagram</span></a></li>
          
        
          
            <li><a href="https://mvp.microsoft.com/en-us/PublicProfile/5000200" rel="nofollow noopener noreferrer me"><i class="fas fa-fw fa-award" aria-hidden="true"></i><span class="label">Microsoft MVP</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="How to access Apple’s App Connect API from C#, Python, and Go. - Part 2">
    <meta itemprop="description" content="  ">
    <meta itemprop="datePublished" content="2021-07-12T09:02:52-04:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="/2021/07/12/how-to-access-apples-app-connect-api-from-c-python-and-go-part-2/" class="u-url" itemprop="url">How to access Apple’s App Connect API from C#, Python, and Go. - Part 2
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
        <div class="wp-block-image">
  <figure class="aligncenter size-large is-resized"><img loading="lazy" src="https://i1.wp.com/photos.smugmug.com/Blog/n-zwT5d/2021/i-rMG2ZL4/0/c712e41f/L/Apple%20Lock%20Green-L.jpg?resize=680%2C510&#038;ssl=1" alt="" width="680" height="510" /></figure>
</div>

<p>In my <a href="/2021/07/09/how-to-access-apples-app-connect-api-from-c-python-and-go-part-1/">previous post</a>, I wrote about a need to query my company’s membership list from our Apple app store development account. In that post, I used C# to query Apple’s API. In this installment, we’ll cover how to accomplish the same task with Python. The <a href="/2021/07/19/how-to-access-apples-app-connect-api-from-c-python-and-go-part-3/">final post</a> will cover a Go version.</p>

<p>As with the C# version, we’ll need to create a signed Javascript Web Token (JWT) and then make some API calls. As with the C# version, I have the code in a Github repository. You can clone it from <a href="https://github.com/anotherlab/IsUserInApple-python">here</a>. The code is in a script named <a href="https://github.com/anotherlab/IsUserInApple-python/blob/main/IsUserInApple.py">IsUserInApple.py</a>. You can name your script anything that the OS and Python allows, I’ll be referring to my script as IsUserInApple.py.</p>

<p>I wrote the code using Python 3, version 3.9.2. Unless you are running Windows, the odds are that you have Python 3 installed. If not, you can get it from the good people at <a href="https://www.python.org/downloads/">python.org</a>. This code should work on any platform that supports Python 3. It should also work (potentially with some changes) with Python 2, but I haven’t tested that.</p>

<p>This script will use a couple of libraries that you will need to install. To make the HTTPS web requests, we’ll be using the <a href="https://docs.python-requests.org/en/master/">Requests</a> library. It <a href="https://youtu.be/OkGaq9xiQZY">does exactly what it says on the tin</a>, “Requests is an elegant and simple HTTP library for Python, built for human beings”. It makes the code for calling Apple’ API simple and easy to follow.</p>

<p>The other library is <a href="https://docs.authlib.org/en/stable/">Authlib</a>, a library for working with OAuth and OpenID Connect. It has everything we need to <a href="https://docs.authlib.org/en/stable/jose/jwt.html">create and sign our JWT</a>. While we need to install all of Authlib, we’ll only being using the jwt module. To install the libraries, you just need to run the pip command like this:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">pip</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">requests</span><span class="w"> </span><span class="nx">authlib</span></code></pre></figure>

<p>If you are not familar with pip. it’s the package manager for Python and will be installed when you install Python. If you already have Python installed, then you already have pip installed.</p>

<p>In the folder that you will have the Python script, you will need a configuration file. It performs the same function as the IsUserInApple.json file did in the C# code. It will contain the path to your private key file, the key id, and the issuer id for your account. Please refer back to <a href="/2021/07/09/how-to-access-apples-app-connect-api-from-c-python-and-go-part-1/">Part 1</a> for how to define these values. Instead of using JSON, I used a simple key/value file and it’s named IsUserInApple.config. It should use the following format:</p>

<figure class="highlight"><pre><code class="language-ini" data-lang="ini"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="code"><pre><span class="nn">[settings]</span>
<span class="py">private_key</span> <span class="p">=</span> <span class="s">c:/scripts/AuthKey.p8</span>
<span class="py">KEY_ID</span> <span class="p">=</span> <span class="s">ABCDEF1234</span>
<span class="py">ISSUER_ID</span> <span class="p">=</span> <span class="s">d88b7c23-4c26-48fb-9d62-5649f27a25a2</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now we can go through the code. I’m going to jump around a bit, you may want to have <a href="https://github.com/anotherlab/IsUserInApple-python/blob/main/IsUserInApple.py">the script</a> open in another window. After some comments, we start with the following lines:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">tempfile</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">configparser</span>
<span class="kn">from</span> <span class="nn">authlib.jose</span> <span class="kn">import</span> <span class="n">jwt</span></code></pre></figure>

<p>The first line imports the libraries that we’ll need. The requests library was the 3rd party library that we installed via pip, the rest are libraries included with Python. The next line imports the jwt model from the authlib.jose library. The “jose” part of the library name is an acronym for <strong>J</strong>avascript <strong>O</strong>bject <strong>S</strong>igning and <strong>E</strong>ncryption.</p>

<p>The next part of the code are the methods we’ll define and use to call the API. We’ll dive into them in a bit. For now, we’ll jump down to the bottom of the script. We start with</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="p">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">configPath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s">"/IsUserInApple.config"</span>
        <span class="n">config</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">configPath</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Line 1 is saying “if we have at least one command line parameter after the name of the script…”. The next line creates an instance of the <a href="https://docs.python.org/3/library/configparser.html">ConfigParser</a> class, which will allow us to easily read contents from the IsUserInApple.config configuation file. Starting at line 3, we’ll use a try/except block to read the config file. We want to read the config file from the same folder as the script. To get that folder name, we call the <a href="https://docs.python.org/3/library/os.path.html?highlight=abspath#os.path.abspath">abspath</a> method on the __file__ variable. The __file__variable is a “<a href="https://www.geeksforgeeks.org/dunder-magic-methods-python/">dunder</a>” variable in Python and represents the name of the currently running module. <a href="https://docs.python.org/3/reference/datamodel.html#special-method-names">A list of dunder variables</a> can be found in the Python Docs. The <a href="https://docs.python.org/3/library/os.path.html#os.path.dirname">dirname</a> method will return the folder part of the file name and then we concatenate that with the name of the config file. And at line 5, we read the config file.</p>

<p>Next, we read the settings into variables with the following code. It’s pretty much self explanatory.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">private_key</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'settings'</span><span class="p">][</span><span class="s">'private_key'</span><span class="p">]</span>    
    <span class="n">KEY_ID</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'settings'</span><span class="p">][</span><span class="s">'KEY_ID'</span><span class="p">]</span>    
    <span class="n">ISSUER_ID</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">'settings'</span><span class="p">][</span><span class="s">'ISSUER_ID'</span><span class="p">]</span>    
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Next, we have the following code:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">private_key</span><span class="p">):</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"Error missing private key file for JWT"</span><span class="p">)</span>

<span class="n">UserEmail</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">lower</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Looking for a match on '</span> <span class="o">+</span> <span class="n">UserEmail</span><span class="p">)</span>

<span class="n">token</span> <span class="o">=</span> <span class="n">getToken</span><span class="p">(</span><span class="n">KEY_ID</span><span class="p">,</span> <span class="n">ISSUER_ID</span><span class="p">,</span> <span class="n">private_key</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>First we check to see if the value provided for private_key is actually a file. Then we set UserEmail to the command line parameter (while converting it to lowercase) and echo that back to the shell. The last line is where we call our getToken method in the script to generate the signed JWT. Now, we’ll jump to that getToken method.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">getToken</span><span class="p">(</span><span class="n">KEY_ID</span><span class="p">,</span> <span class="n">ISSUER_ID</span><span class="p">,</span> <span class="n">PATH_TO_KEY</span><span class="p">):</span>
    <span class="n">EXPIRATION_TIME</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mf">20.0</span> <span class="o">*</span> <span class="mf">60.0</span><span class="p">)))</span> <span class="c1"># 20 minutes timestamp
</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PATH_TO_KEY</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">PRIVATE_KEY</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"alg"</span><span class="p">:</span> <span class="s">"ES256"</span><span class="p">,</span>
        <span class="s">"kid"</span><span class="p">:</span> <span class="n">KEY_ID</span><span class="p">,</span>
        <span class="s">"typ"</span><span class="p">:</span> <span class="s">"JWT"</span>
    <span class="p">}</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"iss"</span><span class="p">:</span> <span class="n">ISSUER_ID</span><span class="p">,</span>
        <span class="s">"exp"</span><span class="p">:</span> <span class="n">EXPIRATION_TIME</span><span class="p">,</span>
        <span class="s">"aud"</span><span class="p">:</span> <span class="s">"appstoreconnect-v1"</span>
    <span class="p">}</span>

    <span class="c1"># Create and return the JWT
</span>    <span class="k">return</span> <span class="n">jwt</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">PRIVATE_KEY</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Line 1 defines the name of the method and the parameter names. <a href="https://tenor.com/EVNQ.gif">No big whoop</a>. Line 2 generates the expiration time, <a href="https://youtu.be/8Y7McIX_m-I">20 minutes into the future</a>. At line 4, we read in the private key file. The jwt module <a href="https://efangelist.wordpress.com/2014/07/29/why-smart-young-people-grok-the-word-grok-do-you-grok-grok/">groks</a> the PEM format, we don’t have to clean it up like <a href="https://github.com/anotherlab/IsUserinApple-dotnet/blob/main/Program.cs#L79">we did in the C# code</a>. Then line 7 creates the header and line 13 creates the payload. This is nearly identical to the code from the C# version. At line 20, we create and sign the JWT and return to the code that called it. It follows the same logic as the code in the GetToken method from <a href="https://github.com/anotherlab/IsUserinApple-dotnet/blob/main/AppleJWT.cs">AppleJWT.cs</a>. Jumping back to where we called getTokem, we have the following line:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">members</span> <span class="o">=</span> <span class="n">getAllUsers</span><span class="p">(</span><span class="n">token</span><span class="p">)</span></code></pre></figure>

<p>Now we’ll dive into the getAllUsers method.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="k">def</span> <span class="nf">getAllUsers</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="n">JWT</span> <span class="o">=</span> <span class="s">'Bearer '</span> <span class="o">+</span> <span class="n">token</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="s">'https://api.appstoreconnect.apple.com/v1/users?limit=100'</span>
    <span class="n">HEAD</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="n">JWT</span><span class="p">}</span>

    <span class="n">teamMembers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">nextURL</span> <span class="o">=</span> <span class="n">URL</span>
    <span class="n">keepGoing</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">while</span> <span class="n">keepGoing</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">nextURL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEAD</span><span class="p">)</span>

        <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">if</span> <span class="s">'errors'</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
            <span class="n">errorCode</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="s">'errors'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Apple returned an HTTP '</span> <span class="o">+</span> <span class="n">errorCode</span><span class="p">[</span><span class="s">'status'</span><span class="p">]</span> <span class="o">+</span> <span class="s">' code'</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">errorCode</span><span class="p">[</span><span class="s">'detail'</span><span class="p">])</span>
            <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">'whoops'</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y</span><span class="p">[</span><span class="s">'data'</span><span class="p">]:</span>
            <span class="n">teamMembers</span><span class="p">.</span><span class="n">append</span><span class="p">({</span><span class="s">'username'</span><span class="p">:</span><span class="n">i</span><span class="p">[</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'username'</span><span class="p">].</span><span class="n">lower</span><span class="p">(),</span> <span class="s">'roles'</span><span class="p">:</span> <span class="s">','</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'roles'</span><span class="p">])})</span>

        <span class="k">if</span> <span class="s">'next'</span> <span class="ow">in</span> <span class="n">y</span><span class="p">[</span><span class="s">'links'</span><span class="p">]:</span>
            <span class="n">nextURL</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="s">'links'</span><span class="p">][</span><span class="s">'next'</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">keepGoing</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="n">teamMembers</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Line 1 defines the method name and parameters. Lines 2-4 sets the <a href="https://swagger.io/docs/specification/authentication/bearer-authentication/">bearer (token) authorization</a> and the inital URL to call. The next few lines just initialize a few variables and the fun begins at line 11 where we’ll loop until we are done. At line 12, we use the requests library to make a HTTPS get call. Line 14 assigns the JSON results to our Y variable. The next block of code checks the JSON document for “errors”. If Apple’s API falls down, it will fall down this way.</p>

<p>If there are no errors, we just walk through the “data” member of JSON document and add the username and roles for each user to the teamMembers array. When we append the username, we convert it to lowercase. That was we don’t have to worry about case when we match on the email address. Then we check the see if the “links” member of the document has a field named “next”. If it does, we use that as the new URL and keep looping. When we don’t have a “next” url, we return the teamMembers array to caller. That takes us back to the bottom of our script again.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="code"><pre>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span> <span class="o">==</span> <span class="n">UserEmail</span><span class="p">:</span>
            <span class="n">HasMatch</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Match on '</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span> <span class="o">+</span> <span class="s">', Roles: '</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="s">'roles'</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">HasMatch</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'No match'</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"Error: Please specify an email address"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now we just iterate through the members array and see if the user name matches. We report back on whether we foiund it or not. The last lines are the error message that would be reported if you ran the script without a email address to match on.</p>

<p>That’s basically all there is to this script. This version doesn’t deserialize the JSON data into objects, it just parses it as is. It’s a trade off. Doing it this way uses less code, but you lose some of the discoverability of having the data in object form.</p>

<p>To run it, you would just do something like:</p>

<figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="n">python</span><span class="w"> </span><span class="nx">IsUserInApple.py</span><span class="w"> </span><span class="nx">some.email</span><span class="err">@</span><span class="nx">company.com</span></code></pre></figure>

<p>You’ll either the following if that use is a member of the account:</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">Looking for a match on some.email@company.com
Match on some.email@company.com, Roles: ADMIN,ACCOUNT_HOLDER</code></pre></figure>

<p>Or the following if that email doesn’t provide a match</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">Looking for a match on some.email@company.com
No match</code></pre></figure>

<p>Coming up next will be the Go version of this script.</p>

<hr class="wp-block-separator" />

<p class="has-small-font-size">
  <em data-rich-text-format-boundary="true">About the image: <br data-rich-text-line-break="true" />This image was derived from some open-source images. The image of the wall comes from <a href="https://unsplash.com/@impatrickt">Patrick Tomasso via Unsplash</a>. The Apple lock logo comes from Apple, which retains all rights to its artwork. The people icon was created by <a href="https://thenounproject.com/search/?q=people&amp;i=165313">Monika from the Noun Project</a>.</em>
</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#apple" class="page__taxonomy-item p-category" rel="tag">Apple</a><span class="sep">, </span>
    
      <a href="/tags/#c" class="page__taxonomy-item p-category" rel="tag">C#</a><span class="sep">, </span>
    
      <a href="/tags/#go" class="page__taxonomy-item p-category" rel="tag">Go</a><span class="sep">, </span>
    
      <a href="/tags/#python" class="page__taxonomy-item p-category" rel="tag">Python</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#apple" class="page__taxonomy-item p-category" rel="tag">Apple</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2021-07-12T09:02:52-04:00">July 12, 2021</time></p>

      </footer>

      <section class="page__share">
  

  <a href="https://twitter.com/intent/tweet?via=anotherlab&text=How+to+access+Apple%27s+App+Connect+API+from+C%23%2C+Python%2C+and+Go.+-+Part+2%20%2F2021%2F07%2F12%2Fhow-to-access-apples-app-connect-api-from-c-python-and-go-part-2%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2F2021%2F07%2F12%2Fhow-to-access-apples-app-connect-api-from-c-python-and-go-part-2%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=%2F2021%2F07%2F12%2Fhow-to-access-apples-app-connect-api-from-c-python-and-go-part-2%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/2021/07/09/how-to-access-apples-app-connect-api-from-c-python-and-go-part-1/" class="pagination--pager" title="How to access Apple’s App Connect API from C#, Python, and Go. - Part 1
">Previous</a>
    
    
      <a href="/2021/07/19/how-to-access-apples-app-connect-api-from-c-python-and-go-part-3/" class="pagination--pager" title="How to access Apple’s App Connect API from C#, Python, and Go. - Part 3
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <section id="giscus-comments"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You May Also Enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2022/01/05/quick-check-for-if-the-locale-ismetric/" rel="permalink">A quick check to see if the user’s locale is metric or imperial
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">While working on a demo mobile app for a course, I needed to know if the units of measurement on the app would be in Imperial units or Metric units. Since I’...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2021/12/28/a-failed-makevalid-call-in-sql-server/" rel="permalink">A failed MakeValid call in SQL Server
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">We hit this strange bug in SQL Server earlier in the year. A single SQL Statement would just kill the connection. It would kill it 100% in any version of SQL...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2021/12/15/Migrated-to-jekyll/" rel="permalink">Moved the blog from WordPress to Jekyll
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">First post under the new regime.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/2021/10/21/resolving-the-net-maui-versioncode-1-0-is-invalid-it-must-be-an-integer-value-error-when-updating-visual-studio-2022-preview/" rel="permalink">Resolving the .NET MAUI “VersionCode 1.0 is invalid. It must be an integer value.” error when updating Visual Studio 2022 Preview
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          2 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I hit the “VersionCode 1.0 is invalid” error with .NET MAUI and resolved it.
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/anotherlab" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/anotherlab" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/christophermiller/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
        
          <li><a href="https://instagram.com/anotherlab" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
        
          <li><a href="https://mvp.microsoft.com/en-us/PublicProfile/5000200" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-award" aria-hidden="true"></i> Microsoft MVP</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Chris Miller. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-215918942-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-215918942-1', { 'anonymize_ip': false});
</script>






    <script>
  'use strict';

  (function () {
    var commentContainer = document.querySelector('#giscus-comments');

    if (!commentContainer) {
      return;
    }

    var script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    script.setAttribute('data-repo', 'anotherlab/anotherlab.github.io');
    script.setAttribute('data-repo-id', '');
    script.setAttribute('data-category', '');
    script.setAttribute('data-category-id', '');
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-theme', 'light');
    script.setAttribute('crossorigin', 'anonymous');

    commentContainer.appendChild(script);
  })();
</script>
  





  </body>
</html>
