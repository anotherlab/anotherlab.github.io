<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Handling collation sequences with temporary tables and table variables with SQL Server | Chris Miller’s 4th Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Handling collation sequences with temporary tables and table variables with SQL Server" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="When building complex stored procedures that span multiple tables, you will probably need to store some intermediate results in a local buffer and process them before returning the final output.  SQL Server lets you do this through temporary table and table variables.  " />
<meta property="og:description" content="When building complex stored procedures that span multiple tables, you will probably need to store some intermediate results in a local buffer and process them before returning the final output.  SQL Server lets you do this through temporary table and table variables.  " />
<link rel="canonical" href="http://localhost:4000/2008/07/10/handling-collation-sequences-with/" />
<meta property="og:url" content="http://localhost:4000/2008/07/10/handling-collation-sequences-with/" />
<meta property="og:site_name" content="Chris Miller’s 4th Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2008-07-10T20:42:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Handling collation sequences with temporary tables and table variables with SQL Server" />
<script type="application/ld+json">
{"datePublished":"2008-07-10T20:42:00-04:00","@type":"BlogPosting","url":"http://localhost:4000/2008/07/10/handling-collation-sequences-with/","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2008/07/10/handling-collation-sequences-with/"},"dateModified":"2008-07-10T20:42:00-04:00","description":"When building complex stored procedures that span multiple tables, you will probably need to store some intermediate results in a local buffer and process them before returning the final output.  SQL Server lets you do this through temporary table and table variables.  ","headline":"Handling collation sequences with temporary tables and table variables with SQL Server","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Chris Miller's 4th Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chris Miller&#39;s 4th Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Handling collation sequences with temporary tables and table variables with SQL Server</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2008-07-10T20:42:00-04:00" itemprop="datePublished">Jul 10, 2008
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>When building complex stored procedures that span multiple tables, you will probably need to store some intermediate results in a local buffer and process them before returning the final output.  SQL Server lets you do this through temporary table and table variables.  </p>

<p>Usually table variables offer faster performance (less locking and logging are required), but they have <a href="http://databases.aspfaq.com/database/should-i-use-a-temp-table-or-a-table-variable.html">more</a> <a href="http://support.microsoft.com/default.aspx/kb/305977">restrictions</a> <a href="http://blogs.msdn.com/sqlprogrammability/archive/2007/01/18/11-0-temporary-tables-table-variables-and-recompiles.aspx">than</a> temporary tables.  Common to both types is where they are located.  When you create a table variable or temporary table, it gets created in the <a href="http://msdn.microsoft.com/en-us/library/ms190768.aspx">tempdb</a> database, not in the current database.  This can affect the <a href="http://msdn.microsoft.com/en-us/library/aa174903(SQL.80).aspx">collation sequences</a> applied to character fields  If the SQL Server was installed using one collation and your database uses a different collation, joins from tables in your database with temporary tables will fail if you join on character fields.  The tempdb database will use the server default collation sequence. That collation may not be the same collation used by your database if your created your database on a different server that used a difference collation.  The server collation is used for all of the system databases (including tempdb) and for any newly created user databases.  Databases that are attached or restored from a backup keep the collation that they were created with.</p>

<p>Gregory Larsen <a href="http://www.sqlservercentral.com/articles/Administering/collate_part1/875/" title="Beware of Mixing Collations - Part 1">posted some sample SQL code</a> on sqlservercentral.com that will demonstrate the error.  If you run the following SQL:&lt;/p&gt;</p>

<pre>create table #a (char_set1 varchar(50) collate Latin1_General_CI_AS) <br />create table #b(char_set2 varchar(50) collate Latin1_General_BIN) <br />insert into #a values ('collate') <br />insert into #b values ('collate') <br />select * from #a join #b on char_set1 = char_set2</pre>
<p>&lt;/p&gt;</p>

<p>You will an error message like the following:</p>

<p>Msg 468, Level 16, State 9, Line 5</p>

<p>Cannot resolve the collation conflict between “Latin1_General_BIN” and “Latin1_General_CI_AS” in the equal to operation.</p>

<p>That example is used to show the type of error you would get in your code.  The actual code that would throw that error would be comparisons between character fields in a temporary table/table variable and with a permanent table in your database.  If you are deploying databases to servers where the server’s default collation sequence could be different than the collation sequence used by your database, then you want to add “<a href="http://msdn.microsoft.com/en-us/library/aa258237(SQL.80).aspx">COLLATE database_default</a>” to all of your character field definitions when you define a temporary table or table variable.  Using “COLLATE Database_Default” will assign the collation sequence of the current database to the field.  This will allow field comparisons between character fields in temporary tables/table variables and permanent tables to execute with triggering the “collation conflict” error.</p>

<p>Instead of using syntax like:&lt;/p&gt;</p>

<pre>create table #a(SomeID integer, SomeCharValue varchar(20)) <br /><br />declare @a TABLE(SomeID integer, SomeCharValue varchar(20)) </pre>

<p>Use the following:&lt;/p&gt;</p>

<pre>create table #a(SomeID integer, SomeCharValue varchar(20) COLLATE database_default) <br /><br />declare @a TABLE(SomeID integer, SomeCharValue varchar(20) COLLATE database_default)</pre>

<p>This will work no matter what the collation sequence for either tempdb or your database.  You don’t need to query the server to check what the sequence.  The big limitation is that you have to explicitly define the columns in the temporary table.  If you were using SELECT INTO syntax to create the temporary table implicitly by the columns in the SELECT statement, the temporary table will use the collation of tempdb.  You would need to structure the SQL.  For example, if you were using syntax like this:&lt;/p&gt;</p>

<pre>select name, crdate, filename<br />into #a<br />from master.dbo.sysdatabases<br />drop table #a</pre>
<p>&lt;/p&gt;</p>

<p>You would need to rewrite it to look like this:&lt;/p&gt;</p>

<pre>create table #a(<br />  name sysname collate database_default,<br />  crdate datetime,<br />  filename nvarchar(260) collate database_default<br />)<br />insert #a(name, crdate, filename)<br />select name, crdate, filename<br />from master.dbo.sysdatabases<br />drop table #a</pre>

<p>You pay a small penalty by the extra SQL to explicitly define the temporary table, but you gain with having code that will work on any server.</p>

  </div><a class="u-url" href="/2008/07/10/handling-collation-sequences-with/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Chris Miller&#39;s 4th Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Chris Miller&#39;s 4th Blog</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">anotherlab</span></a></li><li><a href="https://www.twitter.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">anotherlab</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
