<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Fun with CoInitialize | Chris Miller’s 4th Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="Fun with CoInitialize" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I was tracking down a error in one of the command line apps that I use to save web.config settings over upgrades.  It was a strange error, If I stepped through the code, everything executed correctly, but I would get an access violation when I left a specific method call.  The fun part was that all of the code in that method call executed normally.  The app is written in Delphi 2007 and is Win32 unmanaged code.  The code looked something like this:" />
<meta property="og:description" content="I was tracking down a error in one of the command line apps that I use to save web.config settings over upgrades.  It was a strange error, If I stepped through the code, everything executed correctly, but I would get an access violation when I left a specific method call.  The fun part was that all of the code in that method call executed normally.  The app is written in Delphi 2007 and is Win32 unmanaged code.  The code looked something like this:" />
<link rel="canonical" href="http://localhost:4000/2008/04/07/fun-with-coinitialize/" />
<meta property="og:url" content="http://localhost:4000/2008/04/07/fun-with-coinitialize/" />
<meta property="og:site_name" content="Chris Miller’s 4th Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2008-04-07T15:42:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Fun with CoInitialize" />
<script type="application/ld+json">
{"datePublished":"2008-04-07T15:42:00-04:00","@type":"BlogPosting","url":"http://localhost:4000/2008/04/07/fun-with-coinitialize/","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2008/04/07/fun-with-coinitialize/"},"dateModified":"2008-04-07T15:42:00-04:00","description":"I was tracking down a error in one of the command line apps that I use to save web.config settings over upgrades.  It was a strange error, If I stepped through the code, everything executed correctly, but I would get an access violation when I left a specific method call.  The fun part was that all of the code in that method call executed normally.  The app is written in Delphi 2007 and is Win32 unmanaged code.  The code looked something like this:","headline":"Fun with CoInitialize","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Chris Miller's 4th Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chris Miller&#39;s 4th Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Fun with CoInitialize</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2008-04-07T15:42:00-04:00" itemprop="datePublished">Apr 7, 2008
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I was tracking down a error in one of the command line apps that I use to <a href="http://anotherlab.rajapet.net/2008/04/saving-application-settings-over.html">save web.config settings over upgrades</a>.  It was a strange error, If I stepped through the code, everything executed correctly, but I would get an access violation when I left a specific method call.  The fun part was that all of the code in that method call executed normally.  The app is written in Delphi 2007 and is Win32 unmanaged code.  The code looked something like this:</p>

<pre><span>function</span> TSaveConfig.UpdateWebConfig(<span>const</span> srcfile, destfile: <span>string</span>): <span>boolean</span>;<br />var<br />  fsrcDoc, fDestDoc: IXMLDocument;<br />begin<br />  CoInitialize(nil);<br /><br />  result := <span>true</span>;<br /><br />  fsrcDoc := LoadXMLDocument(srcFile);<br />  fDestDoc := LoadXMLDocument(DestFile);<br /><br />  UpdateNode(fsrcDoc, fDestDoc, <span>'configuration\system.web\httpRuntime', 'executionTimeout', '', '');</span><br />  UpdateNode(fsrcDoc, fDestDoc, <span>'configuration\system.web\sessionState', 'timeout', '', '');</span><br /><br /><span>if</span> fDestdoc.Modified <span>then</span> begin<br />    fDestdoc.SaveToFile(DestFile);<br /><span>end</span>;<br /><br />  CoUninitialize;<br /><span>end</span>;<br /></pre>

<p>Not much to it.  My <a href="http://www.urbandictionary.com/define.php?term=spidey+sense" title="Derived from the &quot;Spidey sense&quot; of the comic book superhero Spiderman, it is generally used to mean a vague but strong sense of something being wrong, dangerous, suspicious, a security situation.">Spidey sense</a> started tingling at the calls to <a href="http://msdn2.microsoft.com/en-us/library/ms678543(VS.85).aspx" title="Initializes the COM library on the current thread and identifies the concurrency model as single-thread apartment (STA). Applications must initialize the COM library before they can call COM library functions other than CoGetMalloc and memory allocation functions.">CoInitialize</a>/<a href="http://msdn2.microsoft.com/en-us/library/ms688715(VS.85).aspx" title="Closes the COM library on the current thread, unloads all DLLs loaded by the thread, frees any other resources that the thread maintains, and forces all RPC connections on the thread to close.">CoUninitialize</a>.  CoInitialize is needed to initialize the COM library on the current thread.  And COM is needed because I am using MS XML COM objects to work with the web.config files.  I was initializing COM, using COM, then uninitializing COM.  The problem was that I was using interfaces to the COM objects and Delphi is managing the lifetime of interfaces.  At the end of the method call, those objects go out of scope and Delphi calls their cleanup code.  In my case this happens after the the call to CoUninitialize.  My IXMLDocument interfaces were being garbage collected by the Delphi runtime and they were referencing a COM library that had been already closed.</p>

<p>In this case, the fix was easy.  I just moved the calls to CoInitialize/CoUninitialize to the code that calls UpdateWebConfig.  Once I did that, my odd little access violation was fixed.  That’s one of those bugs that seems obvious after you fix it.  What clued me in to what was going on was a <a href="http://chrisbensen.blogspot.com/2007/06/delphi-tips-and-tricks.html" title="Chris Bensen: Delphi Tips And Tricks: CoInitialize/CoUninitialize Part I">post by Chris Bensen</a> that explained it all.  Thanks Chris!</p>

  </div><a class="u-url" href="/2008/04/07/fun-with-coinitialize/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Chris Miller&#39;s 4th Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Chris Miller&#39;s 4th Blog</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">anotherlab</span></a></li><li><a href="https://www.twitter.com/anotherlab"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">anotherlab</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
